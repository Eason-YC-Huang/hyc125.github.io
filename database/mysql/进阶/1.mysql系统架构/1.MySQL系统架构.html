<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>1.MySQL系统架构 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="1.MySQL系统架构" class="main-title"></div></div></header><article><h1 class="wolai-block"><span class="inline-wrap">MySQL<span class="jill"></span>系统架构</span></h1><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面是<span class="jill"></span>MySQL<span class="jill"></span>的基本架构示意图，从中你可以清楚地看到<span class="jill"></span>SQL<span class="jill"></span>语句在<span class="jill"></span>MySQL<span class="jill"></span>的各个功能模块中的执行过程。</span></div></div><div class="wolai-block wolai-center"><figure><img src="media/mysql%E6%9E%B6%E6%9E%84%E5%9B%BE.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">大体来说，MySQL<span class="jill"></span>可以分为</span><span class="inline-wrap"><code>Server<span class="jill"></span>层</code></span><span class="inline-wrap">和</span><span class="inline-wrap"><code>存储引擎层</code></span><span class="inline-wrap">两部分。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Server<span class="jill"></span>层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖<span class="jill"></span>MySQL<span class="jill"></span>的大多数核心服务功能，以及所有的内置函数（如日期、时间、数学和加密函数等），所有跨存储引擎的功能都在这一层实现，比如存储过程、触发器、视图等。</span></div></div><div class="wolai-block wolai-text"><div><span class="red inline-wrap"><b>存储引擎层负责数据的存储和提取</b></span><span class="inline-wrap">。其架构模式是插件式的，支持<span class="jill"></span>InnoDB、MyISAM、Memory<span class="jill"></span>等多个存储引擎。现在最常用的存储引擎是<span class="jill"></span>InnoDB，它从<span class="jill"></span>MySQL 5.5.5<span class="jill"></span>版本开始成为了默认存储引擎。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">连接器</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">客户端要想连接到服务器,首先需要与连接器打交道。连接器负责跟客户端建立连接、获取权限、维护和管理连接。连接命令一般是这么写的：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>mysql <span class="token operator">-</span>h$ip <span class="token operator">-</span><span class="token constant">P</span>$port <span class="token operator">-</span>u$user <span class="token operator">-</span>p</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">在完成经典的<span class="jill"></span>TCP<span class="jill"></span>握手后，连接器就要开始认证你的身份，这个时候用的就是你输入的用户名和密码。</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">如果用户名或密码不对，你就会收到一个&quot;Access denied for user&quot;的错误，然后客户端程序结束执行。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">如果用户名密码认证通过，连接器会到权限表里面查出你拥有的权限。之后，这个连接里面的权限判断逻辑，都将依赖于此时读到的权限。</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">一个用户成功建立连接后，即使你用管理员账号对这个用户的权限做了修改，也不会影响已经存在连接的权限。修改完成后，只有再新建的连接才会使用新的权限设置。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">查询缓存</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">连接建立完成后，你就可以执行<span class="jill"></span>select<span class="jill"></span>语句了。执行逻辑就会来到第二步：查询缓存。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">MySQL<span class="jill"></span>拿到一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句。之前执行过的语句及其结果可能会以<span class="jill"></span>key-value<span class="jill"></span>对的形式，被直接缓存在内存中。key<span class="jill"></span>是查询的语句，value<span class="jill"></span>是查询的结果。如果你的查询能够直接在这个缓存中找到<span class="jill"></span>key，那么这个<span class="jill"></span>value<span class="jill"></span>就会被直接返回给客户端。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">如果语句不在查询缓存中，就会继续后面的执行阶段。执行完成后，执行结果会被存入查询缓存中。你可以看到，如果查询命中缓存，MySQL<span class="jill"></span>不需要执行后面的复杂操作，就可以直接返回结果，这个效率会很高。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。对于更新压力大的数据库来说，查询缓存的命中率会非常低。除非你的业务就是有一张静态表，很长时间才会更新一次。比如，一个系统配置表，那这张表上的查询才适合使用查询缓存。</span></div></div><aside class="bg-cultured wolai-block"><div data-symbol="🍄" class="icon"></div><span class="inline-wrap"><b>注意:MySQL 8.0<span class="jill"></span>版本直接将查询缓存的整块功能删掉了</b></span></aside><h3 class="wolai-block"><span class="inline-wrap">分析器</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">如果没有命中查询缓存，就要开始真正执行语句了。首先，MySQL<span class="jill"></span>需要知道你要做什么，因此需要对<span class="jill"></span>SQL<span class="jill"></span>语句做解析。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">分析器先会做“词法分析”。你输入的是由多个字符串和空格组成的一条<span class="jill"></span>SQL<span class="jill"></span>语句，MySQL<span class="jill"></span>需要识别出里面的字符串分别是什么，代表什么。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">MySQL<span class="jill"></span>从你输入的&quot;select&quot;这个关键字识别出来，这是一个查询语句。它也要把字符串“T”识别成“表名<span class="jill"></span>T”，把字符串“ID”识别成“列<span class="jill"></span>ID”。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">做完了这些识别以后，就要做“语法分析”。根据词法分析的结果，语法分析器会根据语法规则，判断你输入的这个<span class="jill"></span>SQL<span class="jill"></span>语句是否满足<span class="jill"></span>MySQL<span class="jill"></span>语法。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">优化器</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">经过了分析器，MySQL<span class="jill"></span>就知道你要做什么了。在开始执行之前，还要先经过优化器的处理。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">执行器</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">MySQL<span class="jill"></span>通过分析器知道了你要做什么，通过优化器知道了该怎么做，于是就进入了执行器阶段，开始执行语句。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">开始执行的时候，要先判断一下你对这个表<span class="jill"></span>T<span class="jill"></span>有没有执行查询的权限，如果没有，就会返回没有权限的错误。如果有权限，就打开表继续执行。打开表的时候，执行器就会根据表的引擎定义，去使用这个引擎提供的接口获取相应的数据。</span></div></div></article><footer></footer></body></html>