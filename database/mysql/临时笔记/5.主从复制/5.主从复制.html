<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>5.主从复制 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="5.主从复制" class="main-title"></div></div></header><article><h1 class="wolai-block"><span class="inline-wrap">主从复制</span></h1><h2 class="wolai-block"><span class="inline-wrap">简介</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">MySQL<span class="jill"></span>数据库提供的主从复制功能可以方便的实现数据的多处自动备份，实现数据库的拓展。多个数据备份不仅可以加强数据的安全性，也可以通过读写分离进一步提升数据库的负载性能。</span></div></div><h2 class="wolai-block"><span class="inline-wrap">工作原理</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">MySQL<span class="jill"></span>之间数据复制的基础是二进制日志文件（binary log file）。一台<span class="jill"></span>MySQL<span class="jill"></span>数据库一旦启用二进制日志后，它的数据库中所有操作都会以“事件”的方式记录在二进制日志中，其他数据库作为<span class="jill"></span>slave<span class="jill"></span>通过一个<span class="jill"></span>I/O<span class="jill"></span>线程与主服务器保持通信，并监控<span class="jill"></span>master<span class="jill"></span>的二进制日志文件的变化，如果发现<span class="jill"></span>master<span class="jill"></span>二进制日志文件发生变化，则会把变化复制到自己的中继日志中，然后<span class="jill"></span>slave<span class="jill"></span>的一个<span class="jill"></span>SQL<span class="jill"></span>线程会把相关的“事件”执行到自己的数据库中，以此实现从数据库和主数据库的一致性，也就实现了主从复制。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>实现<span class="jill"></span>MySQL<span class="jill"></span>主从复制需要进行的配置：</b></span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">主服务器：</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">开启二进制日志</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">配置唯一的<span class="jill"></span>server-id</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">获得<span class="jill"></span>master<span class="jill"></span>二进制日志文件名及位置</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">创建一个用于<span class="jill"></span>slave<span class="jill"></span>和<span class="jill"></span>master<span class="jill"></span>通信的用户账号</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">从服务器：</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">配置唯一的<span class="jill"></span>server-id</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">使用<span class="jill"></span>master<span class="jill"></span>分配的用户账号读取<span class="jill"></span>master<span class="jill"></span>二进制日志</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">启用<span class="jill"></span>slave<span class="jill"></span>服务</span></li></ul></li></ul><h2 class="wolai-block"><span class="inline-wrap">实践</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">主数据库<span class="jill"></span>master<span class="jill"></span>修改：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>1.修改<span class="jill"></span>mysql<span class="jill"></span>配置</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">找到主数据库的配置文件<span class="jill"></span>my.cnf(或者<span class="jill"></span>my.ini)，我的在/etc/mysql/my.cnf,在[mysqld]部分插入如下两行：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
log<span class="token operator">-</span>bin<span class="token operator">=</span>mysql<span class="token operator">-</span>bin #开启二进制日志
server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">1</span> #设置server<span class="token operator">-</span>id</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>2.重启<span class="jill"></span>mysql，创建用于同步的用户账号</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">打开<span class="jill"></span>mysql<span class="jill"></span>会话<span class="jill"></span>shell&gt;mysql -hlocalhost -uname -ppassword</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">创建用户并授权：用户：rel1<span class="jill"></span>密码：slavepass</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Mysql" class="marker"></div><pre># 创建用户
<span class="token constant">CREATE</span> <span class="token constant">USER</span> <span class="token string">'slaver'</span>@<span class="token string">'%'</span> <span class="token constant">IDENTIFIED</span> <span class="token constant">BY</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
# 分配权限
<span class="token constant">GRANT</span> <span class="token constant">REPLICATION</span> <span class="token constant">SLAVE</span> <span class="token constant">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token constant">TO</span> <span class="token string">'slaver'</span>@<span class="token string">'%'</span><span class="token punctuation">;</span>
# 刷新权限
flush privileges<span class="token punctuation">;</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>3.查看<span class="jill"></span>master<span class="jill"></span>状态，记录二进制文件名(mysql-bin.000003)和位置(73)：</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>mysql <span class="token operator">></span> <span class="token constant">SHOW</span> <span class="token constant">MASTER</span> <span class="token constant">STATUS</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> <span class="token maybe-class-name">File</span>             <span class="token operator">|</span> <span class="token maybe-class-name">Position</span> <span class="token operator">|</span> <span class="token maybe-class-name">Binlog_Do_DB</span> <span class="token operator">|</span> <span class="token maybe-class-name">Binlog_Ignore_DB</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token punctuation">.</span><span class="token number">000001</span> <span class="token operator">|</span> <span class="token number">1026</span>     <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">二、从服务器<span class="jill"></span>slave<span class="jill"></span>修改：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>1.修改<span class="jill"></span>mysql<span class="jill"></span>配置</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">同样找到<span class="jill"></span>my.cnf<span class="jill"></span>配置文件，添加<span class="jill"></span>server-id</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>
server<span class="token operator">-</span>id<span class="token operator">=</span><span class="token number">2</span> #设置server<span class="token operator">-</span>id，必须唯一</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>2.重启<span class="jill"></span>mysql，打开<span class="jill"></span>mysql<span class="jill"></span>会话，执行同步<span class="jill"></span>SQL<span class="jill"></span>语句</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">(需要主服务器主机名，登陆凭据，二进制文件的名称和位置)：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>change master to
  master_host<span class="token operator">=</span><span class="token string">'xxxxxx'</span><span class="token punctuation">,</span>
  master_user<span class="token operator">=</span><span class="token string">'slaver'</span><span class="token punctuation">,</span>
  master_password<span class="token operator">=</span><span class="token string">'123456'</span><span class="token punctuation">,</span>
  master_log_file<span class="token operator">=</span><span class="token string">'mysql-bin.000001'</span><span class="token punctuation">,</span>
  master_log_pos<span class="token operator">=</span><span class="token number">1026</span><span class="token punctuation">;</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>3.启动<span class="jill"></span>slave<span class="jill"></span>同步进程：</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>mysql<span class="token operator">></span>start slave<span class="token punctuation">;</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">4.查看<span class="jill"></span>slave<span class="jill"></span>状态：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Mysql" class="marker"></div><pre>mysql<span class="token operator">></span> show slave status\<span class="token constant">G</span><span class="token punctuation">;</span>
<span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span> <span class="token number">1.</span> row <span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">**</span><span class="token operator">*</span>
         <span class="token spread operator">...</span>
             <span class="token maybe-class-name">Slave_IO_Running</span><span class="token operator">:</span> <span class="token maybe-class-name">Yes</span>
            <span class="token maybe-class-name">Slave_SQL_Running</span><span class="token operator">:</span> <span class="token maybe-class-name">Yes</span>
        <span class="token spread operator">...</span>
# 当Slave_IO_Running和Slave_SQL_Running都为<span class="token constant">YES</span>的时候就表示主从同步设置成功了。</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">master<span class="jill"></span>开启二进制日志后默认记录所有库所有表的操作，可以通过配置来指定只记录指定的数据库甚至指定的表的操作，具体在<span class="jill"></span>mysql<span class="jill"></span>配置文件的[mysqld]可添加修改如下选项：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang=".properties" class="marker"></div><pre># 不同步哪些数据库  
binlog<span class="token operator">-</span>ignore<span class="token operator">-</span>db <span class="token operator">=</span> mysql  
binlog<span class="token operator">-</span>ignore<span class="token operator">-</span>db <span class="token operator">=</span> test  
binlog<span class="token operator">-</span>ignore<span class="token operator">-</span>db <span class="token operator">=</span> information_schema  
  
# 只同步哪些数据库，除此之外，其他不同步  
binlog<span class="token operator">-</span><span class="token keyword control-flow">do</span><span class="token operator">-</span>db <span class="token operator">=</span> game</pre></div></code-block><h2 class="wolai-block"><span class="inline-wrap">常见问题</span></h2><h3 class="wolai-block"><span class="inline-wrap">Slave_IO_Running:No</span></h3><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">设置从服务器的<span class="jill"></span>bind-address = *</span></li><li><div class="marker"></div><span class="inline-wrap">主服务器的端口是否开放了</span></li><li><div class="marker"></div><span class="inline-wrap">信息设置是否正确</span></li></ol><h3 class="wolai-block"><span class="inline-wrap">Slave_SQL_Running:NO</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">Google.......</span></div></div><h1 class="wolai-block"><span class="inline-wrap">读写分离</span></h1><h2 class="wolai-block"><span class="inline-wrap">三方软件</span></h2><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ProxySQL</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">阿里云的</span><span class="inline-wrap"><a href="https://cn.aliyun.com/product/rds"><span>RDS</span></a></span><span class="inline-wrap">，其实就是阿里云什么都帮你搞好了，你直接连接一个地址就可以了。</span></li></ul><h2 class="wolai-block"><span class="inline-wrap">代码层面读写分离</span></h2><h3 class="wolai-block"><span class="inline-wrap">1.ReplicationDriver</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">MySQL 提供支持读写分离的驱动类：</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>com.mysql.jdbc.ReplicationDriver</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">用来替代</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>com.mysql.jdbc.Driver</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang=".properties" class="marker"></div><pre>#注意，所有参数主从统一<span class="token punctuation">,</span>用户名和密码也必须相同
jdbc<span class="token punctuation">.</span><span class="token property-access">url</span><span class="token operator">=</span>jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span>replication<span class="token operator">:</span><span class="token operator">/</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;master>,&lt;slave><span class="token charclass class-name">.</span><span class="token charclass class-name">.</span><span class="token charclass class-name">.</span></span><span class="token regex-delimiter">/</span></span><span class="token spread operator">...</span><span class="token operator">?</span><span class="token spread operator">...</span><span class="token operator">=</span><span class="token spread operator">...</span> </pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">触发<span class="jill"></span>Slave<span class="jill"></span>的情况:1.</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>auto_commit = false</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"> 2.</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>readOnly=true</code></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">// 事务开启后，查询自动切换到从库,readOnly默认为false</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span> readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderBase</span><span class="token punctuation">></span></span> <span class="token function">findOrderList</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderCode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">常见情景的结果分析</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>当<span class="jill"></span>Service<span class="jill"></span>中出现自身实例方法的调用时</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span> readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">OrderBase</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">findSubOrderList</span><span class="token punctuation">(</span>orderCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span> readOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderBase</span> orderBase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">findSubOrderList</span><span class="token punctuation">(</span>orderBase<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span> readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderSub</span><span class="token punctuation">></span></span> <span class="token function">findSubOrderList</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>getOrder</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">和</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>updateOrder</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">都调用了</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>findSubOrderList</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">方法，这时</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>findSubOrderList</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">方法的调用对象是</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>this</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">，而不是被<span class="jill"></span>Spring<span class="jill"></span>事务管理器替换过的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>service</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">对象，此时</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>findSubOrderList</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">方法上的<span class="jill"></span>@Transaction<span class="jill"></span>注解无效，它会根据上文环境来决定使用主库还是从库，从而避免一个事务内部出现读写库不统一的情况。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>service<span class="jill"></span>调用了其它<span class="jill"></span>service<span class="jill"></span>的方法</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">// OrderSerivceImpl:</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span> readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">OrderBase</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    orderCouponService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>couponId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span> readOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">OrderBase</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderGeneratorDto</span> dto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    orderCouponService<span class="token punctuation">.</span><span class="token function">saveCoupon</span><span class="token punctuation">(</span>coupon<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span> readOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">OrderBase</span> <span class="token function">updateOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderBase</span> orderBase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    orderCouponService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>couponId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
<span class="token comment">// OrderCouponServiceImpl:</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span> readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">OrderCoupon</span> <span class="token function">getById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> couponId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
  
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span><span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span> readOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">OrderCoupon</span> <span class="token function">saveCoupon</span><span class="token punctuation">(</span><span class="token class-name">OrderCoupon</span> coupon<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">1, 当外部调用</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>OrderSerivce</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>getOrder</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">时，该方法的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>@Transaction</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">注解生效，设置从库查询。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>getOrder</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">内部调用了</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>OrderCouponService</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>getById</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">方法，由于</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>orderCouponService</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">是被<span class="jill"></span>Spring<span class="jill"></span>事务管理器替换过的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>service</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">对象，所以</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>getById</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">方法上的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>@Transaction</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">注解生效。由于</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>Require</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">这个事务传播的特性，</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>getById</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">不会创建新的事务，也就是说使用的是</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>getOrder</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">的事务，所以依旧是由从库读取数据。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">2, 当外部调用</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>OrderSerivce</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>saveOrder</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">时，该方法的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>@Transaction</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">注解生效，设置操作主库。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>saveOrder</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">内部调用了</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>OrderCouponService</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>saveCoupon</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">方法，同样由于<span class="jill"></span>Require<span class="jill"></span>的特性，没有创建新事务，操作主库。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">3, 当外部调用</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>OrderSerivce</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>updateOrder</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">时，</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>updateOrder</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">方法的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>@Transaction</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">注解生效，设置操作主库。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>updateOrder</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">内部调用了</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>OrderCouponService</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">的</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>getById</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">方法，同样由于<span class="jill"></span>Require<span class="jill"></span>的特性，没有创建新事务，从主库读出数据。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">2.Spring<span class="jill"></span>的<span class="jill"></span>AbstractRountingDataSource</span></h3></article><footer></footer></body></html>