<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/wolai.css"/><title>ShardingSphere - wolai 笔记</title><link rel="shortcut icon" href="media/background_logo_1.png"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon icon-image" style="background-image: url(&quot;media/background_logo.png&quot;)"></div></div><div data-title="ShardingSphere" class="main-title"></div></div></header><article><div class="wolai-bookmark wolai-block"><a href="https://github.com/apache/shardingsphere/issues/650">https://github.com/apache/shardingsphere/issues/650</a><div class="info-box"><div class="text-pane"><div data-title="github.com"></div><div class="icon-host"><div data-hostname="github.com"></div></div></div><div class="preview-pane"></div></div></div><div class="wolai-bookmark wolai-block"><a href="https://mp.weixin.qq.com/s/lLct0qY_D82-Wh5zrkzWiQ">在实践中使用ShardingJdbc组件的正确姿势(一)</a><div class="info-box"><div class="text-pane"><div data-title="在实践中使用ShardingJdbc组件的正确姿势(一)"></div><div data-desc="在设计系统时，需要根据实际的业务情况来选用合适的组件构建系统"></div><div class="icon-host"><div class="icon icon-image" style="background-image: url(&quot;http://res.wx.qq.com/a/wx_fed/assets/res/MjliNWVm.svg&quot;)"></div><div data-hostname="mp.weixin.qq.com"></div></div></div><div class="preview-pane" style="background-image: url(http://mmbiz.qpic.cn/mmbiz_png/AtZHGo2bvzIXvsBdvIy7Z9P5MUvSFumDzE5tMwzv0Zo2CPOtiauyn9v2wTozwDjwL6xoQq31ICb3BJweJzeCTPQ/0?wx_fmt=png)"></div></div></div><div class="wolai-bookmark wolai-block"><a href="https://mp.weixin.qq.com/s/X34qKPAs2aHQTvE_6VStiQ">Sharding-Sphere实战：实现类多租户分库分表</a><div class="info-box"><div class="text-pane"><div data-title="Sharding-Sphere实战：实现类多租户分库分表"></div><div data-desc="来自技术交流群朋友的问题，如何借助分库分表中间件实现类似多租户设计！！！"></div><div class="icon-host"><div class="icon icon-image" style="background-image: url(&quot;http://res.wx.qq.com/a/wx_fed/assets/res/MjliNWVm.svg&quot;)"></div><div data-hostname="mp.weixin.qq.com"></div></div></div><div class="preview-pane" style="background-image: url(http://mmbiz.qpic.cn/mmbiz_jpg/4o22OFcmzHmmJLXGia6ODEIaFG4uzt86ibhsEVeYGzNN4AZOOqrcyT1TbbIjf2W5NaVWHFgicbibFaibTQqoMEC4PbQ/0?wx_fmt=jpeg)"></div></div></div><h2 class="wolai-block"><span class="inline-wrap">基本概念</span></h2><h3 class="wolai-block"><span class="inline-wrap">表的概念</span></h3><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">逻辑表：相同逻辑和数据结构表的总称。例：订单数据根据主键尾数拆分为 10 张表，分别是 </span><span class="inline-wrap"><code>t_order_0</code></span><span class="inline-wrap"> 到 </span><span class="inline-wrap"><code>t_order_9</code></span><span class="inline-wrap">，他们的逻辑表名为 </span><span class="inline-wrap"><code>t_order</code></span><span class="inline-wrap">。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">真实表：在分片的数据库中真实存在的物理表。即上个示例中的 </span><span class="inline-wrap"><code>t_order_0</code></span><span class="inline-wrap"> 到 </span><span class="inline-wrap"><code>t_order_9</code></span><span class="inline-wrap">。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">数据节点：数据分片的最小单元。由</span><span class="red inline-wrap">数据源名称</span><span class="inline-wrap">和</span><span class="red inline-wrap">数据表</span><span class="inline-wrap">组成，例：</span><span class="inline-wrap"><code>ds_0.t_order_0</code></span><span class="inline-wrap">。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">绑定表：指分片规则一致的主表和子表。例如：</span><span class="inline-wrap"><code>t_order</code></span><span class="inline-wrap"> 表和 </span><span class="inline-wrap"><code>t_order_item</code></span><span class="inline-wrap"> 表，均按照 </span><span class="inline-wrap"><code>order_id</code></span><span class="inline-wrap"> 分片，则此两张表互为绑定表关系。绑定表之间的多表关联查询不会出现笛卡尔积关联，关联查询效率将大大提升。举例说明，如果 SQL 为：</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="SQL" class="marker"></div><pre><span class="token keyword">SELECT</span> i<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> t_order o <span class="token keyword">JOIN</span> t_order_item i <span class="token keyword">ON</span> o<span class="token punctuation">.</span>order_id<span class="token operator">=</span>i<span class="token punctuation">.</span>order_id <span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>order_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">在不配置绑定表关系时，那么路由后的 SQL 应该为 4 条，它们呈现为笛卡尔积：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="SQL" class="marker"></div><pre><span class="token comment"># t_order 和 t_order_item 都分了两张表</span>
<span class="token comment"># t_order_0、t_order_1、t_order_item_0、t_order_item_1</span>
<span class="token keyword">SELECT</span> i<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> t_order_0 o <span class="token keyword">JOIN</span> t_order_item_0 i <span class="token keyword">ON</span> o<span class="token punctuation">.</span>order_id<span class="token operator">=</span>i<span class="token punctuation">.</span>order_id <span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>order_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> i<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> t_order_0 o <span class="token keyword">JOIN</span> t_order_item_1 i <span class="token keyword">ON</span> o<span class="token punctuation">.</span>order_id<span class="token operator">=</span>i<span class="token punctuation">.</span>order_id <span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>order_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> i<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> t_order_1 o <span class="token keyword">JOIN</span> t_order_item_0 i <span class="token keyword">ON</span> o<span class="token punctuation">.</span>order_id<span class="token operator">=</span>i<span class="token punctuation">.</span>order_id <span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>order_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> i<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> t_order_1 o <span class="token keyword">JOIN</span> t_order_item_1 i <span class="token keyword">ON</span> o<span class="token punctuation">.</span>order_id<span class="token operator">=</span>i<span class="token punctuation">.</span>order_id <span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>order_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">在配置绑定表关系后，路由的 SQL 应该为 2 条：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="SQL" class="marker"></div><pre><span class="token keyword">SELECT</span> i<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> t_order_0 o <span class="token keyword">JOIN</span> t_order_item_0 i <span class="token keyword">ON</span> o<span class="token punctuation">.</span>order_id<span class="token operator">=</span>i<span class="token punctuation">.</span>order_id <span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>order_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> i<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> t_order_1 o <span class="token keyword">JOIN</span> t_order_item_1 i <span class="token keyword">ON</span> o<span class="token punctuation">.</span>order_id<span class="token operator">=</span>i<span class="token punctuation">.</span>order_id <span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>order_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">其中 </span><span class="inline-wrap"><code>t_order</code></span><span class="inline-wrap"> 在 FROM 的最左侧，</span><span class="inline-wrap"><code>ShardingSphere</code></span><span class="inline-wrap"> 将会以它作为整个绑定表的主表。 所有路由计算将会只使用主表的策略，那么 </span><span class="inline-wrap"><code>t_order_item</code></span><span class="inline-wrap"> 表的分片计算将会使用 </span><span class="inline-wrap"><code>t_order</code></span><span class="inline-wrap"> 的条件。故绑定表之间的分区键要完全相同。</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">广播表：所有分片数据源都有的且数据完全一样的表。适用于数据量不大且需要与海量数据的表进行关联查询的场景，例如：字典表。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">单表：所有分片数据源中只存在唯一一张的表</span></li></ul><h3 class="wolai-block"><span class="inline-wrap">分片键</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">用于分片的数据库字段，是将表水平拆分的关键字段。例：将订单表中的订单主键的尾数取模分片，则订单主键为分片字段。 </span><span class="red inline-wrap">SQL 中如果无分片字段，将执行全路由，性能较差。</span><span class="inline-wrap"> </span><span class="inline-wrap">除了对单分片字段的支持，Apache ShardingSphere 也支持根据多个字段进行分片。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">分片算法</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">目前提供 4 种分片算法的接口。 由于分片算法和业务实现紧密相关，因此并未提供内置分片算法的实现，需要应用开发者自行实现分片算法。</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">精准分片算法 </span><span class="inline-wrap"><code>PreciseShardingAlgorithm</code></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">用于处理使用单一键作为分片键的</span><span class="inline-wrap"><code>=</code></span><span class="inline-wrap">、</span><span class="inline-wrap"><code>IN</code></span><span class="inline-wrap">进行分片的场景。</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">范围分片算法 </span><span class="inline-wrap"><code>RangeShardingAlgorithm</code></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">用于处理使用单一键作为分片键的 </span><span class="inline-wrap"><code>=</code></span><span class="inline-wrap">、</span><span class="inline-wrap"><code>IN</code></span><span class="inline-wrap">、</span><span class="inline-wrap"><code>BETWEEN AND</code></span><span class="inline-wrap">、</span><span class="inline-wrap"><code>&gt;</code></span><span class="inline-wrap">、</span><span class="inline-wrap"><code>&lt;</code></span><span class="inline-wrap">、</span><span class="inline-wrap"><code>&gt;=</code></span><span class="inline-wrap">、</span><span class="inline-wrap"><code>&lt;=</code></span><span class="inline-wrap"> 进行分片的场景。</span></div></div><aside class="bg-cultured wolai-block"><div data-symbol="💥" class="icon"></div><span class="inline-wrap">后面看源码你就能发现，他们要实现的方法，前者返回单个库/表，后者返回多个库/表</span></aside></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">复合分片算法 </span><span class="inline-wrap"><code>ComplexKeysShardingAlgorithm</code></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">用于处理使用多键作为分片键进行分片的场景，包含多个分片键的逻辑较复杂，需要应用开发者自行处理其中的复杂度。</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Hint<span class="jill"></span>分片算法</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">对应 </span><span class="inline-wrap"><code>HintShardingAlgorithm</code></span><span class="inline-wrap">，用于处理使用 </span><span class="inline-wrap"><code>Hint</code></span><span class="inline-wrap"> 行分片的场景</span></div></div><div class="wolai-bookmark wolai-block"><a href="https://en.wikipedia.org/wiki/Hint_(SQL)">https://en.wikipedia.org/wiki/Hint_(SQL)</a><div class="info-box"><div class="text-pane"><div data-title="en.wikipedia.org"></div><div class="icon-host"><div data-hostname="en.wikipedia.org"></div></div></div><div class="preview-pane"></div></div></div></li></ul><h3 class="wolai-block"><span class="inline-wrap">分片策略</span></h3><div class="wolai-block wolai-text"><div><span class="red inline-wrap"><b>分片策略 = 分片键<span class="jill"></span>+<span class="jill"></span>分片算法</b></span><span class="inline-wrap">，目前提供了 5<span class="jill"></span>种分片策略。</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">标准分片策略 </span><span class="inline-wrap"><code>StandardShardingStrategy</code></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">提供对 SQL 语句中的 </span><span class="inline-wrap"><code>=</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&gt;</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&lt;</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&gt;=</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&lt;=</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>IN</code></span><span class="inline-wrap"> 和 </span><span class="inline-wrap"><code>BETWEEN AND</code></span><span class="inline-wrap"> 的分片操作支持。 </span><span class="inline-wrap"><code>StandardShardingStrategy</code></span><span class="inline-wrap"> 只支持单分片键，提供 </span><span class="inline-wrap"><code>PreciseShardingAlgorithm</code></span><span class="inline-wrap"> 和 </span><span class="inline-wrap"><code>RangeShardingAlgorithm</code></span><span class="inline-wrap"> 两个分片算法。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>PreciseShardingAlgorithm</code></span><span class="inline-wrap"> 是必须的，用于处理 </span><span class="inline-wrap"><code>=</code></span><span class="inline-wrap"> 和 </span><span class="inline-wrap"><code>IN</code></span><span class="inline-wrap"> 的分片。 </span><span class="inline-wrap"><code>RangeShardingAlgorithm</code></span><span class="inline-wrap"> 是可选的，用于处理 </span><span class="inline-wrap"><code>BETWEEN AND</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&gt;</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&lt;</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&gt;=</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&lt;=</code></span><span class="inline-wrap"> 分片，如果不配置 </span><span class="inline-wrap"><code>RangeShardingAlgorithm</code></span><span class="inline-wrap">，SQL 中的 </span><span class="inline-wrap"><code>BETWEEN AND</code></span><span class="inline-wrap"> 将按照全库路由处理。（验证一下，我觉得</span><span class="inline-wrap"><code>PreciseShardingAlgorithm</code></span><span class="inline-wrap">只能处理</span><span class="inline-wrap"><code>IN</code></span><span class="inline-wrap">）</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">复合分片策略 </span><span class="inline-wrap"><code>ComplexShardingStrategy</code></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">提供对 SQL 语句中的 </span><span class="inline-wrap"><code>=</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&gt;</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&lt;</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&gt;=</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>&lt;=</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>IN</code></span><span class="inline-wrap"> 和 </span><span class="inline-wrap"><code>BETWEEN AND</code></span><span class="inline-wrap"> 的分片操作支持。 </span><span class="inline-wrap"><code>ComplexShardingStrategy</code></span><span class="inline-wrap"> 支持多分片键，由于多分片键之间的关系复杂，因此并未进行过多的封装，而是直接将分片键值组合以及分片操作符透传至分片算法，完全由应用开发者实现，提供最大的灵活度。</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">内联分片策略 </span><span class="inline-wrap"><code>InlineShardingStrategy</code></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">使用</span><span class="inline-wrap"><code>ShardingSphere</code></span><span class="inline-wrap">提供的行表达式进行分片</span></div></div><div class="wolai-bookmark wolai-block"><a href="https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/inline-expression/">行表达式 :: ShardingSphere</a><div class="info-box"><div class="text-pane"><div data-title="行表达式 :: ShardingSphere"></div><div class="icon-host"><div class="icon icon-image" style="background-image: url(&quot;https://shardingsphere.apache.org/document/current/img/favicon.png&quot;)"></div><div data-hostname="shardingsphere.apache.org"></div></div></div><div class="preview-pane"></div></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">Hint<span class="jill"></span>分片策略</span><span class="inline-wrap"><code>HintShardingStrategy</code></span><div class="wolai-block wolai-text"><div><span class="inline-wrap">通过 Hint 指定分片值而非从 SQL 中提取分片值的方式进行分片的策略。</span></div></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">不分片策略 </span><span class="inline-wrap"><code>NoneShardingStrategy</code></span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><h2 class="wolai-block"><span class="inline-wrap">ShardingSphere-JDBC</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">JDBC<span class="jill"></span>离不开</span><span class="inline-wrap"><code>DataSource</code></span><span class="inline-wrap">，我们看下使用<span class="jill"></span>ShardingSphere-JDBC<span class="jill"></span>要怎么创建</span><span class="inline-wrap"><code>DataSource</code></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token annotation punctuation">@NoArgsConstructor</span><span class="token punctuation">(</span>access <span class="token operator">=</span> <span class="token class-name">AccessLevel</span><span class="token punctuation">.</span>PRIVATE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ShardingDataSourceFactory</span> <span class="token punctuation">{</span>
    
    <span class="token doc-comment comment">/**
     * Create sharding data source.
     *
     * <span class="token keyword">@param</span> <span class="token parameter">dataSourceMap</span> data source map
     * <span class="token keyword">@param</span> <span class="token parameter">shardingRuleConfig</span> rule configuration for databases and tables sharding
     * <span class="token keyword">@param</span> <span class="token parameter">props</span> properties for data source
     * <span class="token keyword">@return</span> sharding data source
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">SQLException</span></span> SQL exception
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DataSource</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span>
            <span class="token comment">// Map&lt;数据源名称,DataSource></span>
            <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DataSource</span><span class="token punctuation">></span></span> dataSourceMap<span class="token punctuation">,</span> 
            <span class="token comment">// 分片规则配置</span>
            <span class="token keyword">final</span> <span class="token class-name">ShardingRuleConfiguration</span> shardingRuleConfig<span class="token punctuation">,</span> 
            <span class="token comment">// 属性配置</span>
            <span class="token keyword">final</span> <span class="token class-name">Properties</span> props<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ShardingDataSource</span><span class="token punctuation">(</span>dataSourceMap<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ShardingRule</span><span class="token punctuation">(</span>shardingRuleConfig<span class="token punctuation">,</span> dataSourceMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">可以看出，最重要的应该就是</span><span class="inline-wrap"><code>ShardingRuleConfiguration</code></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ShardingRuleConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">RuleConfiguration</span> <span class="token punctuation">{</span>
    <span class="token comment">// 表规则配置</span>
    <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TableRuleConfiguration</span><span class="token punctuation">></span></span> tableRuleConfigs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 绑定表</span>
    <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> bindingTableGroups <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 广播表</span>
    <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> broadcastTables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 默认数据源名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> defaultDataSourceName<span class="token punctuation">;</span>
    <span class="token comment">// 默认数据库分片策略配置</span>
    <span class="token keyword">private</span> <span class="token class-name">ShardingStrategyConfiguration</span> defaultDatabaseShardingStrategyConfig<span class="token punctuation">;</span>
    <span class="token comment">// 默认表分片配置策略</span>
    <span class="token keyword">private</span> <span class="token class-name">ShardingStrategyConfiguration</span> defaultTableShardingStrategyConfig<span class="token punctuation">;</span>
    <span class="token comment">// 默认主键生成策略</span>
    <span class="token keyword">private</span> <span class="token class-name">KeyGeneratorConfiguration</span> defaultKeyGeneratorConfig<span class="token punctuation">;</span>
    <span class="token comment">// 主从规则配置</span>
    <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MasterSlaveRuleConfiguration</span><span class="token punctuation">></span></span> masterSlaveRuleConfigs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加密规则配置</span>
    <span class="token keyword">private</span> <span class="token class-name">EncryptRuleConfiguration</span> encryptRuleConfig<span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">先来看下 </span><span class="inline-wrap"><code>TableRuleConfiguration</code></span><span class="inline-wrap"> 里面有什么</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TableRuleConfiguration</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> logicTable<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> actualDataNodes<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">ShardingStrategyConfiguration</span> databaseShardingStrategyConfig<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">ShardingStrategyConfiguration</span> tableShardingStrategyConfig<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">KeyGeneratorConfiguration</span> keyGeneratorConfig<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">TableRuleConfiguration</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> logicTable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>logicTable<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">TableRuleConfiguration</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> logicTable<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> actualDataNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkArgument</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>logicTable<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"LogicTable is required."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logicTable <span class="token operator">=</span> logicTable<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>actualDataNodes <span class="token operator">=</span> actualDataNodes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>TableRuleConfiguration</code></span><span class="inline-wrap">居然也有</span><span class="inline-wrap"><code>ShardingStrategyConfiguration</code></span><span class="inline-wrap">和</span><span class="inline-wrap"><code>KeyGeneratorConfiguration</code></span><span class="inline-wrap">，看来这两个东西真的很重要</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>ShardingStrategyConfiguration</code></span><span class="inline-wrap"> 是一个空接口，里面没有任何方法和成员变量，不难想象它的实现类应该是由框架提供的，而且对实现类的使用应该是硬编码在框架里面的</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ShardingStrategyConfiguration</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">我们来看看他有哪些实现类</span></div></div><div class="wolai-block wolai-center"><figure><img src="media/image.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">根据名称，我们来看个最基本的实现类</span><span class="inline-wrap"><code>StandardShardingStrategyConfiguration</code></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">StandardShardingStrategyConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">ShardingStrategyConfiguration</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> shardingColumn<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PreciseShardingAlgorithm</span> preciseShardingAlgorithm<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RangeShardingAlgorithm</span> rangeShardingAlgorithm<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> shardingColumn<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">PreciseShardingAlgorithm</span> preciseShardingAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>shardingColumn<span class="token punctuation">,</span> preciseShardingAlgorithm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">StandardShardingStrategyConfiguration</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> shardingColumn<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">PreciseShardingAlgorithm</span> preciseShardingAlgorithm<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RangeShardingAlgorithm</span> rangeShardingAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkArgument</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Strings</span><span class="token punctuation">.</span><span class="token function">isNullOrEmpty</span><span class="token punctuation">(</span>shardingColumn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ShardingColumns is required."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>preciseShardingAlgorithm<span class="token punctuation">,</span> <span class="token string">"PreciseShardingAlgorithm is required."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>shardingColumn <span class="token operator">=</span> shardingColumn<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>preciseShardingAlgorithm <span class="token operator">=</span> preciseShardingAlgorithm<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rangeShardingAlgorithm <span class="token operator">=</span> rangeShardingAlgorithm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">看到它这三个成员变量，不禁想起前面看到的，</span><span class="inline-wrap"><b>分片策略 = 分片主键<span class="jill"></span>+<span class="jill"></span>分片算法</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">可以看出</span><span class="inline-wrap"><code>StandardShardingStrategyConfiguration</code></span><span class="inline-wrap">它有两个分片算法，分别是精准分片算法(</span><span class="inline-wrap"><code>PreciseShardingAlgorithm</code></span><span class="inline-wrap">)和范围分配算法(</span><span class="inline-wrap"><code>RangeShardingAlgorithm</code></span><span class="inline-wrap">)</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PreciseShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">ShardingAlgorithm</span> <span class="token punctuation">{</span>
    
    <span class="token doc-comment comment">/**
     * Sharding.
     * 
     * <span class="token keyword">@param</span> <span class="token parameter">availableTargetNames</span> available data sources or tables's names
     * <span class="token keyword">@param</span> <span class="token parameter">shardingValue</span> sharding value
     * <span class="token keyword">@return</span> sharding result for data source or table's name
     */</span>
    <span class="token class-name">String</span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">PreciseShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> shardingValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ShardingAlgorithm</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>ShardingAlgorithm</code></span><span class="inline-wrap">也是个空接口，但是</span><span class="inline-wrap"><code>PreciseShardingAlgorithm</code></span><span class="inline-wrap">不是空接口，看来这个接口就是我们要实现的了，看到这里不禁又想起前面看到的</span></div></div><blockquote class="wolai-block"><span class="inline-wrap">由于分片算法和业务实现紧密相关，因此并未提供内置分片算法，而是通过分片策略将各种场景提炼出来，提供更高层级的抽象，并提供接口让应用开发者自行实现分片算法</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap">来总结一下我们目前学到的内容</span></div></div><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">关键的类及其关联关系</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">ShardingDataSource → ShardingRuleConfiguration → TableRuleConfiguration → ShardingStrategyConfiguration → ShardingAlgorithm</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">TableRuleConfiguration：针对某张表的规则的配置</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">ShardingStrategyConfiguration：分片策略</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">ShardingAlgorithm：分片算法</span></div></div></li><li><div class="marker"></div><span class="inline-wrap">核心思想</span><div class="wolai-block wolai-text"><div><span class="inline-wrap">ShardingSphere-JDBC<span class="jill"></span>会给你一些信息，然后你根据这些信息计算出要查哪个表，并反馈给它</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">我会得到哪些信息？我要如何反馈它查哪张表？</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">上面这一步其实就是发生在</span><span class="inline-wrap"><code>ShardingAlgorithm</code></span><span class="inline-wrap">里面的，以</span><span class="inline-wrap"><code>PreciseShardingAlgorithm</code></span><span class="inline-wrap">为例</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PreciseShardingAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">ShardingAlgorithm</span> <span class="token punctuation">{</span>
    
    <span class="token doc-comment comment">/**
     * Sharding.
     * 
     * <span class="token keyword">@param</span> <span class="token parameter">availableTargetNames</span> available data sources or tables's names
     * <span class="token keyword">@param</span> <span class="token parameter">shardingValue</span> sharding value
     * <span class="token keyword">@return</span> sharding result for data source or table's name
     */</span>
    <span class="token class-name">String</span> <span class="token function">doSharding</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> availableTargetNames<span class="token punctuation">,</span> <span class="token class-name">PreciseShardingValue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> shardingValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">可以看出，它给你数据源或者表名以及值，你返回一个数据源名称或表名</span></div></div></li></ol><h2 class="wolai-block"><span class="inline-wrap">实战-分库分表</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">几个库？几张表？每张表分成多少份？</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">先把表确认下来吧，要有绑定表</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">订单表、订单商品表</span></div></div><div class="wolai-bookmark wolai-block"><a href="https://github.com/macrozheng/mall-learning">https://github.com/macrozheng/mall-learning</a><div class="info-box"><div class="text-pane"><div data-title="github.com"></div><div class="icon-host"><div data-hostname="github.com"></div></div></div><div class="preview-pane"></div></div></div><h2 class="wolai-block"><span class="inline-wrap">实战-读写分离</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div></article><footer></footer></body></html>