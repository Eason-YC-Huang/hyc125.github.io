<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../css/wolai.css"/><title>2.Redis服务器 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="2.Redis服务器" class="main-title"></div></div></header><article><h2 class="wolai-block"><span class="inline-wrap">Redis<span class="jill"></span>数据库</span></h2><h3 class="wolai-block"><span class="inline-wrap">Redis<span class="jill"></span>服务器上的数据库</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">Redis<span class="jill"></span>采用的是客户端-服务器架构，在服务器上面运行着多个<span class="jill"></span>Redis<span class="jill"></span>数据库。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token keyword">struct</span> <span class="token class-name">redisServer</span><span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 一个数组，保存着服务器中所有的数据库</span>
    redisDb <span class="token operator">*</span>db<span class="token punctuation">;</span>
    <span class="token comment">// 数据库数量</span>
    <span class="token keyword">int</span> dbnum<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">默认情况下，Redis<span class="jill"></span>客户端会操作<span class="jill"></span>0<span class="jill"></span>号数据库，我们可以通过</span><span class="inline-wrap"><code>SELECT</code></span><span class="inline-wrap">命令修改操作的数据库</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="PowerShell" class="marker"></div><pre>redis> <span class="token function">SET</span> msg <span class="token string">"hello world"</span>
OK
redis> GET msg
hello world
<span class="token operator">/</span><span class="token operator">/</span> 选择数据库1
redis> <span class="token function">SELECT</span> 1
OK
redis<span class="token punctuation">[</span>1<span class="token punctuation">]</span>> GET msg
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span></pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">记录键值对的字典</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">在上面我们知道，Redis<span class="jill"></span>数据库由一种叫</span><span class="inline-wrap"><code>redisDb</code></span><span class="inline-wrap">的结构所表示。其中，</span><span class="inline-wrap"><code>redisDb</code></span><span class="inline-wrap">结构中存在一个</span><span class="inline-wrap"><code>dict</code></span><span class="inline-wrap"> 结构，它保存了数据库中所有的键值对，我们将这个字典称为键空间。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisDb</span><span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 数据库键空间，保存着数据库中的所有键值对</span>
    dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
    <span class="token comment">// ....</span>
<span class="token punctuation">}</span> redisDb<span class="token punctuation">;</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">键空间和用户所见的数据库是直接对应的：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">键空间的键也就是数据库的键，每个键都是一个字符串对象。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">键空间的值也就是数据库的值，每个值可以是<span class="jill"></span>Redis<span class="jill"></span>五种数据结构中的任意一种。</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">举个例子，如果我们在空白的数据库执行以下命令：</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre>redis<span class="token operator">></span> <span class="token constant">SET</span> message <span class="token string">"hello world"</span>
ok
redis<span class="token operator">></span> <span class="token constant">RPUSH</span> alphabet <span class="token string">"a"</span> <span class="token string">"b"</span> <span class="token string">"c"</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span>
redis<span class="token operator">></span> <span class="token constant">HSET</span> book name <span class="token string">"Redis in Action"</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
redis<span class="token operator">></span> <span class="token constant">HSET</span> book author <span class="token string">"Josiah L. Carlson"</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>
redis<span class="token operator">></span> <span class="token constant">HSET</span> book publisher <span class="token string">"Manning"</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">那么执行完这些命令后，数据库的键空间将会是如下图所示</span></div></div><div class="wolai-block wolai-center"><figure><img src="media/redis%E9%94%AE%E7%A9%BA%E9%97%B4%E4%BE%8B%E5%AD%90.png" style="width: 737px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">记录键过期信息的字典</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">Redis<span class="jill"></span>支持我们对某个键设置生存时间或过期时间，这是通过</span><span class="inline-wrap"><code>redisDb</code></span><span class="inline-wrap">结构中的</span><span class="inline-wrap"><code>expires</code></span><span class="inline-wrap">字典实现的，该字典保存了数据库中所有键的过期时间。（生存时间：存活多久。过期时间：在什么时候过期）</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Redis<span class="jill"></span>提供了四种命令，让我们实现上面两种功能。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="C" class="marker"></div><pre>EXPIRE <span class="token operator">&lt;</span>key<span class="token operator">></span> <span class="token operator">&lt;</span>ttl<span class="token operator">></span>  <span class="token comment">// 生存时间，秒为单位</span>
PEXPIRE <span class="token operator">&lt;</span>key<span class="token operator">></span> <span class="token operator">&lt;</span>ttl<span class="token operator">></span> <span class="token comment">// 生存时间，毫秒为单位</span>
EXPIREAT <span class="token operator">&lt;</span>key<span class="token operator">></span> <span class="token operator">&lt;</span>timestamp<span class="token operator">></span> <span class="token comment">// 存活时间，秒数时间戳</span>
PEXPIREAT <span class="token operator">&lt;</span>key<span class="token operator">></span> <span class="token operator">&lt;</span>timestamp<span class="token operator">></span> <span class="token comment">// 存活时间，毫秒数时间戳</span>
<span class="token comment">// 其实底层都是调用PEXPIREAT</span>
TTL <span class="token operator">&lt;</span>KEY<span class="token operator">></span> <span class="token comment">// 剩余时间，秒为单位</span>
PTTL <span class="token operator">&lt;</span>KEY<span class="token operator">></span> <span class="token comment">// 剩余时间，毫秒为单位</span>
PERSIST <span class="token operator">&lt;</span>KEY<span class="token operator">></span> <span class="token comment">// 取消对一个键的过期时间</span></pre></div></code-block><div class="wolai-block wolai-center"><figure><img src="media/redis%E8%BF%87%E6%9C%9F%E5%AD%97%E5%85%B8%E4%BE%8B%E5%AD%90.png" style="width: 760px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">过期键删除策略</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">在上面我们知道了如何存储键的过期信息，以及如何判断一个键是否过期，那么下一个问题就是如何删除过期的键。</span></div></div><div class="wolai-block wolai-center"><figure><img src="media/%E8%BF%87%E6%9C%9F%E9%94%AE%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A51.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>定时删除</b></span></div></div><div class="wolai-block wolai-center"><figure><img src="media/%E8%BF%87%E6%9C%9F%E9%94%AE%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5-%E5%AE%9A%E6%97%B6%E5%88%A0%E9%99%A4.png" style="width: 759.5px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>惰性删除</b></span></div></div><div class="wolai-block wolai-center"><figure><img src="media/%E8%BF%87%E6%9C%9F%E9%94%AE%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5-%E6%83%B0%E6%80%A7%E5%88%A0%E9%99%A4.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>定期删除</b></span></div></div><div class="wolai-block wolai-center"><figure><img src="media/%E8%BF%87%E6%9C%9F%E9%94%AE%E5%88%A0%E9%99%A4%E7%AD%96%E7%95%A5-%E5%AE%9A%E6%9C%9F%E5%88%A0%E9%99%A4.png" style="width: 759.5px"/></figure></div><h3 class="wolai-block"><span class="inline-wrap">Redis<span class="jill"></span>的过期键删除策略</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">Redis<span class="jill"></span>服务器使用的是惰性删除和定时删除两种策略。</span></div></div><h2 class="wolai-block"><span class="inline-wrap">事务管理</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">.</span></div></div><div class="wolai-block wolai-center"><figure><img src="media/redis%E4%BA%8B%E5%8A%A1%E7%AE%80%E4%BB%8B.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-center"><figure><img src="media/redis%E4%BA%8B%E5%8A%A1watch%E5%91%BD%E4%BB%A4%E5%8E%9F%E7%90%86.png" style="width: 760px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Redis<span class="jill"></span>事务的本质就是使用队列，把命令存入队列中，然后再按顺序执行。如果在入队过程中出现错误，则不行执行该事务，如果是在执行队列中命令的过程中出错，事务会继续执行，数据不会回滚。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://redisbook.readthedocs.io/en/latest/feature/transaction.html"><span>Redis<span class="jill"></span>事务</span></a></span></div></div><h2 class="wolai-block"><span class="inline-wrap">持久化</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">Redis<span class="jill"></span>提供两种机制实现数据的持久化，分别是<span class="jill"></span>RDB<span class="jill"></span>和<span class="jill"></span>AOF。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">RDB</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">RDB<span class="jill"></span>是<span class="jill"></span>Redis DataBase<span class="jill"></span>的缩写，RDB<span class="jill"></span>是一个经过压缩的二进制文件，通过该文件可以还原生成<span class="jill"></span>RDB<span class="jill"></span>时的数据库状态。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">有两个命令创建<span class="jill"></span>RDB<span class="jill"></span>文件，分别是<span class="jill"></span>SAVE、BGSAVE。前者会阻塞<span class="jill"></span>Redis<span class="jill"></span>服务器进程，直到<span class="jill"></span>RDB<span class="jill"></span>文件创建完毕，后者则是创建一个子进程，由子进程生成<span class="jill"></span>RDB<span class="jill"></span>文件。我们可以通过<span class="jill"></span>Redis<span class="jill"></span>配置文件中的<span class="jill"></span>save<span class="jill"></span>选项设置多个保存条件，只要任意一个条件满足，服务器就会执行<span class="jill"></span>BGSAVE<span class="jill"></span>命令。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">RDB<span class="jill"></span>文件的载入工作是在服务器启动时自动执行的，因此没有专门用于载入<span class="jill"></span>RDB<span class="jill"></span>文件的命令。载入<span class="jill"></span>RDB<span class="jill"></span>文件的期间，Redis<span class="jill"></span>服务器会处于阻塞状态。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">AOF</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">AOF Append Only File，通过保存<span class="jill"></span>Redis<span class="jill"></span>服务器所执行的命令来记录数据库状态。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">当<span class="jill"></span>AOF<span class="jill"></span>持久化功能打开后，服务器执行完一个命令后，会将指令添加到缓冲区，然后再把缓冲区中的数据写入到<span class="jill"></span>AOF<span class="jill"></span>文件。AOF<span class="jill"></span>文件会越来越大，Redis<span class="jill"></span>提供了一条执行让我们重写<span class="jill"></span>AOF<span class="jill"></span>文件，从而减少文件的大小 BGREWRITEAOF。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">SAVE、BGSAVE、BGREWRITEAOF</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>BGSAVE<span class="jill"></span>执行期间，服务器拒绝接受<span class="jill"></span>SAVE<span class="jill"></span>和新的<span class="jill"></span>BGSAVE<span class="jill"></span>命令。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>BGSAVE<span class="jill"></span>执行期间，BGREWRITEAOF<span class="jill"></span>命令会在<span class="jill"></span>BGSAVE<span class="jill"></span>执行之后再执行。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">BGREWRITEAOF<span class="jill"></span>命令执行期间，服务器拒绝接受<span class="jill"></span>BGSAVE<span class="jill"></span>命令。</span></div></div><h2 class="wolai-block"><span class="inline-wrap">主从</span></h2><h2 class="wolai-block"><span class="inline-wrap">哨兵</span></h2><h2 class="wolai-block"><span class="inline-wrap">集群</span></h2></article><footer></footer></body></html>