<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>4.线程同步机制-下 - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="4.线程同步机制-下" class="main-title"></div></div></header><article><h2 class="wolai-block"><span class="inline-wrap">wait<span class="jill"></span>和<span class="jill"></span>notify</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">有些时候,线程<span class="jill"></span>A<span class="jill"></span>可能要等待另一个线程<span class="jill"></span>B<span class="jill"></span>完成某件事情后,它才能执行它的操作.这时候我们就需要一种机制,让<span class="jill"></span>A<span class="jill"></span>等待<span class="jill"></span>B,让<span class="jill"></span>B<span class="jill"></span>通知<span class="jill"></span>A.</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>Java<span class="jill"></span>平台中,</span><span class="inline-wrap"><code>Object.wait()/Object.wait(long)</code></span><span class="inline-wrap">和</span><span class="inline-wrap"><code>Object.nofity()和<span class="jill"></span>Object.notifyAll</code></span><span class="inline-wrap">可以实现等待和通知.</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">// 使用Object.wait()实现等待的伪代码</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>someObj<span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token comment">// 为什么需要使用同步代码块?</span>
    <span class="token comment">// 线程只有获取了someObj的锁,才能调用someObj的wait方法.</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>保护条件不成立<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 执行wait方法</span>
        someObj<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// wait方法做了以下事情</span>
        <span class="token comment">// 1.检查当前线程是否拥有someObj的内部锁,如果没有,抛出IllegalMonitorStateException异常</span>
        <span class="token comment">// 2.查看当前线程是否存在someObj的等待池中,如果不在,则放进等待池</span>
        <span class="token comment">// 3.线程释放someObj的内部锁</span>
        <span class="token comment">// 4.线程进入等待状态,直到别的线程调用someObj的notify或notifyAll方法</span>
        <span class="token comment">// 5.线程被唤醒,去申请someObj的内部锁</span>
        <span class="token comment">// 6.获取内部锁后,将当前线程从someObj的等待池中移除</span>
        <span class="token comment">// 7.wait方法执行完毕</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 为什么通过循环来段条件是否成立?</span>
    <span class="token comment">// 等待线程(调用wait方法的线程)被唤醒后,可能没有获得someObj的内部锁,然后别的线程进行了某些操作,导致条件又不成立,所以需要循环判断</span>
    
    <span class="token comment">// 代码执行到这里,说明条件已满足,可以开始执行目标动作</span>
    <span class="token function">doAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">// 使用Object.notify()实现等待的伪代码</span>
synchronize <span class="token punctuation">(</span>someObj<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">updateState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    someObj<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// notify方法的执行不会释放someObj的内部锁,只有该同步代码块执行完,someObj的内部锁才会被释放</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">Java<span class="jill"></span>虚拟机为每个对象维护了<span class="jill"></span>EntrySet<span class="jill"></span>和<span class="jill"></span>WaitSet</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">EntrySet<span class="jill"></span>存储想要获取该对象内部锁的线程</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">WaitSet<span class="jill"></span>存储等待被该对象唤醒的线程</span></li></ul><h3 class="wolai-block"><span class="inline-wrap">wait/notify<span class="jill"></span>的开销及问题</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">下面我们来看看使用<span class="jill"></span>wait/notify<span class="jill"></span>时可能遇到的问题和解决方法</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">过早唤醒：通知线程调用<span class="jill"></span>notify<span class="jill"></span>方法从等待池中随机唤醒一个等待线程，但是通知线程对条件的改变，跟被唤醒的线程完全没有关系</span><div class="wolai-block wolai-center"><figure><img src="media/wait-notify-%E8%BF%87%E6%97%A9%E5%94%A4%E9%86%92.png" style="width: 731px"/></figure></div></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">信号丢失问题：通知线程调用了<span class="jill"></span>notify<span class="jill"></span>之后，等待线程才调用了<span class="jill"></span>wait<span class="jill"></span>方法，如果后续通知线程调用<span class="jill"></span>notify，那么等待线程就会一直处于等待状态。</span></li></ul><h2 class="wolai-block"><span class="inline-wrap">Condition</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">wait<span class="jill"></span>和<span class="jill"></span>notify<span class="jill"></span>用起来不方便，对此<span class="jill"></span>Java5<span class="jill"></span>新增了<span class="jill"></span>Condition<span class="jill"></span>接口，用来代替<span class="jill"></span>wait<span class="jill"></span>和<span class="jill"></span>notify。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token doc-comment comment">/**
 * 使用condition实现单生产者 单消费者的生产者消费者模式
 * 口诀：
 *  作为一名生产者，无需生产，则等待，生产完毕，做记录并通知
 *  作为一名消费者，无需消费，则等待，消费完毕，做记录并通知
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConditionDemo</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Condition</span> condition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果有多个消费者,不能用signal,唤醒的可能是消费者,然后条件不成立,导致无人唤醒生产者</span>
        condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ready<span class="token punctuation">)</span>
          condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果有多个生产者,不能用signal,唤醒的可能是生产者,然后条件不成立,导致无人唤醒消费者</span>
        condition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">对比<span class="jill"></span>wait<span class="jill"></span>和<span class="jill"></span>notify，Condition<span class="jill"></span>的优势是一个显式锁可以创建多个<span class="jill"></span>Condition<span class="jill"></span>对象，从而避免叫错人问题.</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">阻塞队列是一种特殊的集合类，它不仅拥有容器的作用，还能协调生产者和消费者线程的控制流程。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">那些可以通过自身状态来协调线程的的控制流程的对象，叫做同步者（Synchronizers）。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">阻塞队列可以算是一种同步者，除此之外，JDK<span class="jill"></span>还提供了一些其它的同步者，分别是<span class="jill"></span>Latch、Semaphore、Barrier。</span></div></div><h2 class="wolai-block"><span class="inline-wrap">Latch</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">Latch：</span><span class="inline-wrap"><b>a device for keeping a door or gate closed, consisting of a metalbar that fits into a hole and is lifted by pushing down on another bar.</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">门栓、闭锁</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">![](../images/java concurrency latch example.jpeg)</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>什么是闭锁？</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">闭锁作为一种同步工具类，它的作用相当于有一扇门，在闭锁打开之前，这扇门是无法打开的，因此任何线程都无法通过这扇门，当条件允许时，闭锁就会被打开，大门将永远保持打开。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>闭锁的作用？</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">闭锁可以用来确保某些活动会在另一些活动完成之后才进行。例如：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">确保某个计算它所需要的资源，在计算之前就已经被准备好</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">确保某个服务在进行之前，它所依赖的其它服务已经准备好了</span></li></ul><h3 class="wolai-block"><span class="inline-wrap">CountDownLatch</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">闭锁的实现就是</span><span class="inline-wrap"><code>CountDownLatch</code></span><span class="inline-wrap">。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">构造</span><span class="inline-wrap"><code>CountDownLatch</code></span><span class="inline-wrap">的时候需要给定一个计数量（count），每次调用</span><span class="inline-wrap"><code>countDown()</code></span><span class="inline-wrap">方法就会减少一次，当计量数为<span class="jill"></span>0<span class="jill"></span>的时候，唤醒所有等待中的线程。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>CountDownLatch</code></span><span class="inline-wrap">有两个重要方法，一个是</span><span class="inline-wrap"><code>countDown</code></span><span class="inline-wrap"> 使计时器减<span class="jill"></span>1，一个是</span><span class="inline-wrap"><code>await</code></span><span class="inline-wrap"> 阻塞当前线程直到计时器为<span class="jill"></span>0。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>例子</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">class</span> <span class="token class-name">Driver</span> <span class="token punctuation">{</span> <span class="token comment">// ...</span>
   <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
     <span class="token class-name">CountDownLatch</span> doneSignal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token class-name">N</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">Executor</span> e <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">N</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token comment">// create and start threads</span>
       e<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WorkerRunnable</span><span class="token punctuation">(</span>doneSignal<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     doneSignal<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// wait for all to finish</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">class</span> <span class="token class-name">WorkerRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> doneSignal<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>
     
   <span class="token class-name">WorkerRunnable</span><span class="token punctuation">(</span><span class="token class-name">CountDownLatch</span> doneSignal<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>doneSignal <span class="token operator">=</span> doneSignal<span class="token punctuation">;</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>i <span class="token operator">=</span> i<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
     
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token function">doWork</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
       doneSignal<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// return;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
 <span class="token punctuation">}</span></pre></div></code-block><h2 class="wolai-block"><span class="inline-wrap">Barrier</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">Barrier（屏障）的作用是等待一组线程，等到这组线程全部都到达屏障，才让他们通过。</span></div></div><h3 class="wolai-block"><span class="inline-wrap">CyclicBarrier</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">屏障的实现就是</span><span class="inline-wrap"><code>CyclicBarrier</code></span><span class="inline-wrap">。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>CyclicBarrier</code></span><span class="inline-wrap">可以使一定数量的参加者反复地在屏障出集合，当线程到达屏障位置时，它调用<span class="jill"></span>await<span class="jill"></span>方法，这个方法会阻塞，直到有所线程都到达屏障位置。如果线程都达到了，屏障将会打开。如果<span class="jill"></span>await<span class="jill"></span>调用超时或者<span class="jill"></span>await<span class="jill"></span>阻塞的线程被打断，那么屏障就认为是被打破了，其它调用<span class="jill"></span>await<span class="jill"></span>的线程都会被终止并且抛出</span><span class="inline-wrap"><code>BrokenBarrierException</code></span><span class="inline-wrap">。</span></div></div><h2 class="wolai-block"><span class="inline-wrap">Phaser</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">Phaser<span class="jill"></span>是一个用来实现线程同步的工具类。我把<span class="jill"></span>Phaser<span class="jill"></span>叫做阶段管理器，每个阶段需要完成规定数量的任务才能进入下一个阶段。每个阶段需要完成的任务可以动态调整。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">// 入门例子</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Phaser</span> phaser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phaser</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化一个阶段管理器,规定每个阶段完成2个任务才能进入下一个阶段</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前阶段:"</span> <span class="token operator">+</span> phaser<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
    phaser<span class="token punctuation">.</span><span class="token function">arrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 已完成一个任务，但还差一个</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前阶段:"</span> <span class="token operator">+</span> phaser<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0 </span>
    phaser<span class="token punctuation">.</span><span class="token function">arrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 两个任务已完成，进入下一阶段</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前阶段:"</span> <span class="token operator">+</span> phaser<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 </span>
    <span class="token comment">//---------------------------------------------------------------</span>
    phaser<span class="token punctuation">.</span><span class="token function">arriveAndDeregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 已完成一个任务，并且下阶段需要完成的任务数减1</span>
    phaser<span class="token punctuation">.</span><span class="token function">arrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 两个任务已完成，进入下一阶段</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前阶段:"</span> <span class="token operator">+</span> phaser<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    <span class="token comment">//---------------------------------------------------------------</span>
    phaser<span class="token punctuation">.</span><span class="token function">arrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完成一个任务,由于该阶段只需要完成一个任务，所以进入下一阶段</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前阶段:"</span> <span class="token operator">+</span> phaser<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
    <span class="token comment">//---------------------------------------------------------------</span>
    phaser<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从该阶段开始，需要完成的任务数加1</span>
    phaser<span class="token punctuation">.</span><span class="token function">arrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 已完成一个任务，但还差一个</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前阶段:"</span> <span class="token operator">+</span> phaser<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
    phaser<span class="token punctuation">.</span><span class="token function">arrive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 两个任务已完成，进入下一阶段</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前阶段:"</span> <span class="token operator">+</span> phaser<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>深入理解</b></span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>phaser</code></span><span class="inline-wrap">和</span><span class="inline-wrap"><code>phase</code></span><span class="inline-wrap">
</span><span class="inline-wrap"><code>Phaser</code></span><span class="inline-wrap">把一组任务的执行分为多个阶段(</span><span class="inline-wrap"><code>phase</code></span><span class="inline-wrap">)，到达阶段后，任务可以选择开始下一阶段的工作或者停止执行。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>party</code></span><span class="inline-wrap"> 通过</span><span class="inline-wrap"><code>phaser</code></span><span class="inline-wrap">实现同步的线程被称为</span><span class="inline-wrap"><code>party</code></span><span class="inline-wrap">，所有需要同步的</span><span class="inline-wrap"><code>party</code></span><span class="inline-wrap">必须持有同一个</span><span class="inline-wrap"><code>phaser</code></span><span class="inline-wrap">对象。</span><span class="inline-wrap">
</span><span class="inline-wrap"><code>party</code></span><span class="inline-wrap">可以向</span><span class="inline-wrap"><code>phaser</code></span><span class="inline-wrap">注册，执行</span><span class="inline-wrap"><code>phaser.register()</code></span><span class="inline-wrap">方法注册。</span><span class="inline-wrap">
</span><span class="inline-wrap">也可以通过构造器注册，比如</span><span class="inline-wrap"><code>new Phaser(5)</code></span><span class="inline-wrap">就会在创建</span><span class="inline-wrap"><code>phaser</code></span><span class="inline-wrap">对象时注册<span class="jill"></span>5<span class="jill"></span>个</span><span class="inline-wrap"><code>party</code></span><span class="inline-wrap">，随后这<span class="jill"></span>5<span class="jill"></span>个</span><span class="inline-wrap"><code>party</code></span><span class="inline-wrap">只要持有该</span><span class="inline-wrap"><code>phaser</code></span><span class="inline-wrap">对象并调用该对象的<span class="jill"></span>API<span class="jill"></span>就能实现同步。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>arrived</code></span><span class="inline-wrap">和</span><span class="inline-wrap"><code>unarrived</code></span><span class="inline-wrap">
</span><span class="inline-wrap"><code>party</code></span><span class="inline-wrap">到达某个阶段之前处于</span><span class="inline-wrap"><code>unarrived</code></span><span class="inline-wrap">状态,到达时处于</span><span class="inline-wrap"><code>arrived</code></span><span class="inline-wrap">状态.一个</span><span class="inline-wrap"><code>arrived</code></span><span class="inline-wrap">的</span><span class="inline-wrap"><code>party</code></span><span class="inline-wrap">也被称为</span><span class="inline-wrap"><code>arrival</code></span><span class="inline-wrap">.</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>deregister</code></span><span class="inline-wrap">
</span><span class="inline-wrap">一个线程可以在到达(arrive)某个阶段(phase)后退出(deregister),此时可以使用</span><span class="inline-wrap"><code>arriveAndDeregister()</code></span><span class="inline-wrap">方法.</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>advance</code></span><span class="inline-wrap">
</span><span class="inline-wrap"><code>Phaser</code></span><span class="inline-wrap">类有一个</span><span class="inline-wrap"><code>phase</code></span><span class="inline-wrap">计数，初始阶段为<span class="jill"></span>0，当一个阶段的所有线程到达(arrive)时，会将<span class="jill"></span>phase<span class="jill"></span>计数加<span class="jill"></span>1,这个动作被称为</span><span class="inline-wrap"><code>advance</code></span><span class="inline-wrap">。当这个计数达到</span><span class="inline-wrap"><code>Integer.MAX_VALUE</code></span><span class="inline-wrap">时,会被重置为<span class="jill"></span>0,不过相信很多程序不可能达到这个值.</span><span class="inline-wrap">
</span><span class="inline-wrap">在</span><span class="inline-wrap"><code>advance</code></span><span class="inline-wrap">过程中,会触发</span><span class="inline-wrap"><code>boolean onAdvance(int phase, int registeredParties)</code></span><span class="inline-wrap">方法的执行，该方法可以让我们在进入下一阶段之前执行一些操作。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>Tiering</code></span><span class="inline-wrap">
</span><span class="inline-wrap"><code>Tiering</code></span><span class="inline-wrap">（分层），Phaser<span class="jill"></span>支持分层结构，通过构造函数</span><span class="inline-wrap"><code>Phaser(Phaser parent)</code></span><span class="inline-wrap">和</span><span class="inline-wrap"><code>Phaser(Phaser parent, int parties)</code></span><span class="inline-wrap">构造一个树形结构。这有助于减轻因在单个的<span class="jill"></span>Phaser<span class="jill"></span>上注册过多的任务而导致的竞争，从而提升吞吐量，代价是增加单个操作的开销。</span></li></ul><h2 class="wolai-block"><span class="inline-wrap">Semaphore</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">Semaphore<span class="jill"></span>是一种基于计数的信号量。它可以设定一个阈值，基于此，多个线程竞争获取许可信号，做完自己的申请后归还，超过阈值后，线程申请许可信号将会被阻塞。Semaphore<span class="jill"></span>可以用来构建一些对象池，资源池之类的，比如数据库连接池，我们也可以创建计数为<span class="jill"></span>1<span class="jill"></span>的<span class="jill"></span>Semaphore，将其作为一种类似互斥锁的机制，这也叫二元信号量，表示两种互斥状态。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre> <span class="token keyword">class</span> <span class="token class-name">Pool</span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_AVAILABLE <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Semaphore</span> available <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span>MAX_AVAILABLE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
     available<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token function">getNextAvailableItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putItem</span><span class="token punctuation">(</span><span class="token class-name">Object</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">markAsUnused</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
       available<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Not a particularly efficient data structure; just for demo</span>

   <span class="token keyword">protected</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> items <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> whatever kinds of items being managed
   <span class="token keyword">protected</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> used <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span>MAX_AVAILABLE<span class="token punctuation">]</span><span class="token punctuation">;</span>

   <span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token class-name">Object</span> <span class="token function">getNextAvailableItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_AVAILABLE<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>used<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          used<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// not reached</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">markAsUnused</span><span class="token punctuation">(</span><span class="token class-name">Object</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_AVAILABLE<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">==</span> items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>used<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            used<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span></pre></div></code-block><h2 class="wolai-block"><span class="inline-wrap">Exchanger</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">Exchanger<span class="jill"></span>是另一种形式的屏障，用于线程间的数据交换，等到双方都到达各自的屏障时，这两个线程可以进行数据交换。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token class-name">Exchanger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">Money</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">></span><span class="token punctuation">></span></span> exchanger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exchanger</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">Money</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token class-name">Thread</span> buyer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
  <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Money</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">></span></span> pair <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Money</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pair<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Money</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    pair <span class="token operator">=</span> exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pair<span class="token punctuation">.</span>getProduct<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Thread</span> seller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
  <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Money</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">></span></span> pair <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pair</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Money</span><span class="token punctuation">,</span> <span class="token class-name">Product</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pair<span class="token punctuation">.</span><span class="token function">setProduct</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token string">"MacBook Pro"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    pair <span class="token operator">=</span> exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pair<span class="token punctuation">.</span>getMoney<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block></article><footer></footer></body></html>