<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../../css/wolai.css"/><title>AOP - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="AOP" class="main-title"></div></div></header><article><h1 class="wolai-block"><span class="inline-wrap">1.什么是<span class="jill"></span>AOP</span></h1><div class="wolai-block wolai-text"><div><span class="inline-wrap">AOP(面向切面编程)，是一种编程思想，通过切面(aspect)实现对横切关注点的统一管理。</span></div></div><blockquote class="wolai-block"><span class="inline-wrap">横切关注点：指的是一些横跨多个模块的行为。例如权限认证、日志、缓存、事务管理等等。</span><span class="inline-wrap">
</span><span class="inline-wrap">按照功能对一个系统进行划分，我们得到一个个关注点。关注点分为核心关注点和横切关注点。核心关注点完成业务的核心功能。横切关注点分散于核心关注点的各处，为核心关注点提供服务，例如日志、安全认证、事务管理等。</span></blockquote><div class="wolai-block wolai-text"><div><span class="inline-wrap">下图是没有使用<span class="jill"></span>AOP<span class="jill"></span>时的情况</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="media/%E6%B2%A1%E6%9C%89%E4%BD%BF%E7%94%A8aop%E6%97%B6.png" style="width: 758px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">下图是使用<span class="jill"></span>AOP<span class="jill"></span>时的情况</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="media/%E4%BD%BF%E7%94%A8aop%E6%97%B6.png" style="width: 747px"/></figure></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">可以看出，在没有使用<span class="jill"></span>AOP<span class="jill"></span>时，安全模块处于被动调用的情况，我们很难对它的调用者进行统一管理。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">而使用<span class="jill"></span>AOP<span class="jill"></span>时，安全模块通过切面可以主动选择它的调用者，从而实现对调用者的统一管理。</span></div></div><h1 class="wolai-block"><span class="inline-wrap">2.AOP<span class="jill"></span>基本术语</span></h1><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">join point：在程序运行期间，程序会暴露出一些点（</span><span class="inline-wrap"><code>point</code></span><span class="inline-wrap">），例如方法的执行、创建对象、抛出异常等等。我们可以在这些点上插入切面，实现功能扩展。这些点就叫做</span><span class="inline-wrap"><code>joint point</code></span><span class="inline-wrap">。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">pointcut：</span><span class="inline-wrap"><code>join point</code></span><span class="inline-wrap">有很多，我们要从中选择出满足我们需求的点，根据某些条件选出来的点，就叫做</span><span class="inline-wrap"><code>pointcut</code></span><span class="inline-wrap">。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">advice：</span><span class="inline-wrap"><code>advice</code></span><span class="inline-wrap">是在</span><span class="inline-wrap"><code>joint point</code></span><span class="inline-wrap">中执行的行为，例如安全认证，事务管理等等。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">aspect：</span><span class="inline-wrap"><code>aspect</code></span><span class="inline-wrap">（切面）是一个实现横切关注点的模块单元。</span><span class="inline-wrap"><code>aspect</code></span><span class="inline-wrap">里面包含了</span><span class="inline-wrap"><code>advice</code></span><span class="inline-wrap">和</span><span class="inline-wrap"><code>join point</code></span><span class="inline-wrap">。（做什么？对谁做？）</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">weaving：把核心功能和切面组合在一起的过程叫做</span><span class="inline-wrap"><code>weaving</code></span><span class="inline-wrap">（编织）。</span></li></ul><h1 class="wolai-block"><span class="inline-wrap">3AOP<span class="jill"></span>的分类</span></h1><div class="wolai-block wolai-text"><div><span class="inline-wrap">AOP<span class="jill"></span>分为动态<span class="jill"></span>AOP<span class="jill"></span>和静态<span class="jill"></span>AOP，这两者的区别在于编织过程（weaving process）是何时发生，以及如何实现。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">从<span class="jill"></span>Java<span class="jill"></span>的角度来说，静态<span class="jill"></span>AOP<span class="jill"></span>就是在编译时期，对字节码文件进行修改和扩展。从性能上来讲，静态<span class="jill"></span>AOP<span class="jill"></span>比动态<span class="jill"></span>AOP<span class="jill"></span>要好，缺点就是对切面修改后，需要对整个应用进行重新编译。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">对比之下不难理解，动态<span class="jill"></span>AOP<span class="jill"></span>就是在程序运行过程中执行编织过程，具体这个怎么实现，要看你所使用的框架，例如<span class="jill"></span>Spring<span class="jill"></span>的话是通过动态代理实现的。</span></div></div><h1 class="wolai-block"><span class="inline-wrap">4.AspectJ</span></h1><div class="wolai-block wolai-text"><div><span class="inline-wrap">《AspectJ In Action》</span></div></div><h1 class="wolai-block"><span class="inline-wrap">5.Spring AOP</span></h1><div class="wolai-block wolai-text"><div><span class="inline-wrap">Spring AOP<span class="jill"></span>提供了两种使用方式：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">编程式<span class="jill"></span>AOP  现在已经基本不用了，也就不讲了，《Pro Spring 5》 《精通<span class="jill"></span>Spring 4.x》</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">声明式<span class="jill"></span>AOP</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">其中声明式<span class="jill"></span>AOP<span class="jill"></span>又有三种用法，分别是</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">@AspectJ<span class="jill"></span>风格的注解</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">ProxyFactoryBean</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">XML<span class="jill"></span>命名空间   其实背后用的也是<span class="jill"></span>ProxyFactoryBean，这个也不讲了，《Pro Spring 5》《精通<span class="jill"></span>Spring 4.x》</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">在<span class="jill"></span>Spring<span class="jill"></span>中，Advice<span class="jill"></span>有<span class="jill"></span>6<span class="jill"></span>种，分别是：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>BeforeAdvice</code></span><span class="inline-wrap"> : 目标方法执行前进行某些操作</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>AfterAdvice</code></span><span class="inline-wrap"> : 目标方法执行后进行某些操作(无论是否出错)</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>AfterReturningAdvice</code></span><span class="inline-wrap"> : 目标方法正确执行后进行某些操作</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>ThrowsAdvice</code></span><span class="inline-wrap"> : 目标方法执行出错后进行某些操作</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>MethodInterceptor</code></span><span class="inline-wrap"> : 目标方法执行前后进行某些操作</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>IntroductionInterceptor</code></span><span class="inline-wrap"> : 给目标类引入新的方法和属性</span></li></ul><h1 class="wolai-block"><span class="inline-wrap">6.ProxyFactoryBean</span></h1><div class="wolai-block wolai-text"><div><span class="inline-wrap">《Pro Spring 5》《精通<span class="jill"></span>Spring 4.x》</span></div></div><h1 class="wolai-block"><span class="inline-wrap">7.AspectJ<span class="jill"></span>风格注解</span></h1><div class="wolai-block wolai-text"><div><span class="inline-wrap">Spring<span class="jill"></span>支持<span class="jill"></span>@AspectJ<span class="jill"></span>风格的注解，当然它底层使用的还是<span class="jill"></span>Spring<span class="jill"></span>的<span class="jill"></span>AOP<span class="jill"></span>机制。</span></div></div><h2 class="wolai-block"><span class="inline-wrap">1.启动<span class="jill"></span>@AspectJ<span class="jill"></span>注解支持</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">在配置类添加</span><span class="inline-wrap"><code>@EnableAspectJAutoProxy</code></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppConfig</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></pre></div></code-block><h2 class="wolai-block"><span class="inline-wrap">2.定义<span class="jill"></span>Aspect</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">使用</span><span class="inline-wrap"><code>@Aspect</code></span><span class="inline-wrap">修饰一个类</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span> <span class="token comment">// 让Spring扫描到这个类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NotVeryUsefulAspect</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">Aspect<span class="jill"></span>的初始化模式</span></h4><h2 class="wolai-block"><span class="inline-wrap">3.定义<span class="jill"></span>Pointcut</span></h2><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"execution(* transfer(..))"</span><span class="token punctuation">)</span><span class="token comment">// the pointcut expression</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">anyOldTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">// the pointcut signature must have a void return type</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">Pointcut<span class="jill"></span>描述符</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">Spring AOP<span class="jill"></span>支持以下切入点描述符</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>execution</code></span><span class="inline-wrap">: 匹配方法级别的<span class="jill"></span>Join Point</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>@target</code></span><span class="inline-wrap">: 目标类具有某个注解</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>@annotation</code></span><span class="inline-wrap">: 目标方法具有某个注解</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>@args</code></span><span class="inline-wrap">: 运行时的实际参数类型具有某个注解</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>bean</code></span><span class="inline-wrap">：Spring<span class="jill"></span>额外提供的，用来指定<span class="jill"></span>Bean<span class="jill"></span>名，支持通配符</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>within</code></span><span class="inline-wrap">: Limits matching to join points within certain types (the execution of a method declared within a matching type when using Spring AOP).</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>@within</code></span><span class="inline-wrap">: Limits matching to join points within types that have the given annotation (the execution of methods declared in types with the given annotation when using Spring AOP).</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>this</code></span><span class="inline-wrap">: 指定代理对象的类型</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>target</code></span><span class="inline-wrap">: 指定目标对象的类型</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>args</code></span><span class="inline-wrap">: 指定方法的参数类型</span></li></ul><h4 class="wolai-block"><span class="inline-wrap">例子</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>execution</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token function">execution</span><span class="token punctuation">(</span><span class="token punctuation">[</span>访问修饰符<span class="token punctuation">]</span> 返回类型 <span class="token punctuation">[</span>类全限定名<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">方法名</span><span class="token punctuation">(</span>参数<span class="token punctuation">)</span> <span class="token punctuation">[</span>异常<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
execution表达式支持通配符
<span class="token operator">*</span>匹配所有字符
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token property-access">一般用于匹配多个包，多个参数</span>
<span class="token operator">+</span>表示类及其子类
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token function">例子：</span><span class="token punctuation">(</span><span class="token string">"execution (* com.sample.service.impl..*.*(..))"</span><span class="token punctuation">)</span>

<span class="token function">execution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> 表达式主体

第一个<span class="token operator">*</span>号：表示返回类型，<span class="token operator">*</span>号表示所有的类型

com<span class="token punctuation">.</span><span class="token property-access">sample</span><span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">.</span><span class="token property-access">impl</span> 包名
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token property-access">表示当前包和当前包的所有子包</span>

第二个<span class="token operator">*</span>号：表示类名，<span class="token operator">*</span>号表示所有的类

第三个<span class="token operator">*</span>好：表示方法名，<span class="token operator">*</span>号表示所有的方法

（）里面的是参数，<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token property-access">表示所有参数</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">// 所有public修饰的方法</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 所有方法名是set开头的方法</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> set<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// AccountService类的所有方法</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xyz<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>AccountService</span><span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// com.xyz.service包下所有类的所有方法</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> com<span class="token punctuation">.</span>xyz<span class="token punctuation">.</span>service<span class="token punctuation">.</span>*<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// com.xyz.service包及其子包下所有类的所有方法</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> com<span class="token punctuation">.</span>xyz<span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token punctuation">.</span>*<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>within</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">//匹配Person类中的所有方法</span>
<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"within(com.cjm.model.Person)"</span><span class="token punctuation">)</span>

<span class="token comment">//匹配com.cjm包及其子包中所有类中的所有方法</span>
<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"within(com.cjm..*)"</span><span class="token punctuation">)</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>其它</b></span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">// 代理对象实现了AccountService接口</span>
<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"this(com.xyz.service.AccountService)"</span><span class="token punctuation">)</span>
<span class="token comment">// 目标对象实现了AccountService接口</span>
<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"target(com.xyz.service.AccountService)"</span><span class="token punctuation">)</span>
<span class="token comment">// 目标对象被@Transactional注解修饰的</span>
<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"@target(org.springframework.transaction.annotation.Transactional)"</span><span class="token punctuation">)</span>
<span class="token comment">// 传递过来的参数是Serializable类型的</span>
<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"args(java.io.Serializable)"</span><span class="token punctuation">)</span>
<span class="token comment">// 传递过来的参数被@Classified注解修饰的</span>
<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"@args(com.xyz.security.Classified)"</span><span class="token punctuation">)</span>

<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"bean(tradeService)"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"bean(*Service)"</span><span class="token punctuation">)</span></pre></div></code-block><h2 class="wolai-block"><span class="inline-wrap">4.定义<span class="jill"></span>Advice</span></h2><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">// Before Advice</span>
<span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"com.xyz.myapp.SystemArchitecture.dataAccessOperation()"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"dataAccessOperation()"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"execution(* com.xyz.myapp.dao.*.*(..))"</span><span class="token punctuation">)</span>

<span class="token comment">// After Returning Advice</span>
<span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span><span class="token string">"dataAccessOperation()"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAccessCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span>pointcut<span class="token operator">=</span><span class="token string">"dataAccessOperation()"</span><span class="token punctuation">,</span>returning<span class="token operator">=</span><span class="token string">"retVal"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAccessCheck</span><span class="token punctuation">(</span><span class="token class-name">Object</span> retVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// After Throwing Advice</span>
<span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span>pointcut<span class="token operator">=</span><span class="token string">"dataAccessOperation()"</span><span class="token punctuation">,</span>throwing<span class="token operator">=</span><span class="token string">"ex"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRecoveryActions</span><span class="token punctuation">(</span><span class="token class-name">DataAccessException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// After (Finally) Advice</span>
<span class="token annotation punctuation">@After</span><span class="token punctuation">(</span><span class="token string">"dataAccessOperation()"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doReleaseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// Around Advice</span>
<span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"businessService()"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doBasicProfiling</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
  <span class="token comment">// start stopwatch</span>
  <span class="token class-name">Object</span> retVal <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// stop stopwatch</span>
  <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 第一个参数必须是ProceedingJoinPoint类型，用来执行目标方法</span>
<span class="token comment">// proceed方法可以接收一个Object[] 作为目标方法参数</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">获取当前<span class="jill"></span>JoinPoint</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">Any advice method may declare, as its first parameter, a parameter of type</span><span class="inline-wrap"><code>org.aspectj.lang.JoinPoint</code></span><span class="inline-wrap"> (note that around advice is required to declare a first parameter of type </span><span class="inline-wrap"><code>ProceedingJoinPoint</code></span><span class="inline-wrap">, which is a subclass of </span><span class="inline-wrap"><code>JoinPoint</code></span><span class="inline-wrap">. The </span><span class="inline-wrap"><code>JoinPoint</code></span><span class="inline-wrap">interface provides a number of useful methods:</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>getArgs()</code></span><span class="inline-wrap">: Returns the method arguments.</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>getThis()</code></span><span class="inline-wrap">: Returns the proxy object.</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>getTarget()</code></span><span class="inline-wrap">: Returns the target object.</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>getSignature()</code></span><span class="inline-wrap">: Returns a description of the method that is being advised.</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>toString()</code></span><span class="inline-wrap">: Prints a useful description of the method being advised.</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap">See the </span><span class="inline-wrap"><a href="https://www.eclipse.org/aspectj/doc/released/runtime-api/org/aspectj/lang/JoinPoint.html"><span>javadoc</span></a></span><span class="inline-wrap"> for more detail.</span></div></div><h4 class="wolai-block"><span class="inline-wrap">传递参数给<span class="jill"></span>Advice</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap">We have already seen how to bind the returned value or exception value (using after returning and after throwing advice). To make argument values available to the advice body, you can use the binding form of </span><span class="inline-wrap"><code>args</code></span><span class="inline-wrap">. If you use a parameter name in place of a type name in an args expression, the value of the corresponding argument is passed as the parameter value when the advice is invoked. An example should make this clearer. Suppose you want to advise the execution of DAO operations that take an </span><span class="inline-wrap"><code>Account</code></span><span class="inline-wrap"> object as the first parameter, and you need access to the account in the advice body. You could write the following:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"com.xyz.myapp.SystemArchitecture.dataAccessOperation() &amp;&amp; args(account,..)"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">validateAccount</span><span class="token punctuation">(</span><span class="token class-name">Account</span> account<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">The </span><span class="inline-wrap"><code>args(account,..)</code></span><span class="inline-wrap"> part of the pointcut expression serves two purposes. First, it restricts matching to only those method executions where the method takes at least one parameter, and the argument passed to that parameter is an instance of </span><span class="inline-wrap"><code>Account</code></span><span class="inline-wrap">. Second, it makes the actual </span><span class="inline-wrap"><code>Account</code></span><span class="inline-wrap"> object available to the advice through the </span><span class="inline-wrap"><code>account</code></span><span class="inline-wrap"> parameter.</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">Another way of writing this is to declare a pointcut that “provides” the </span><span class="inline-wrap"><code>Account</code></span><span class="inline-wrap"> object value when it matches a join point, and then refer to the named pointcut from the advice. This would look as follows:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"com.xyz.myapp.SystemArchitecture.dataAccessOperation() &amp;&amp; args(account,..)"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">accountDataAccessOperation</span><span class="token punctuation">(</span><span class="token class-name">Account</span> account<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"accountDataAccessOperation(account)"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">validateAccount</span><span class="token punctuation">(</span><span class="token class-name">Account</span> account<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">The proxy object ( </span><span class="inline-wrap"><code>this</code></span><span class="inline-wrap">), target object ( </span><span class="inline-wrap"><code>target</code></span><span class="inline-wrap">), and annotations ( </span><span class="inline-wrap"><code>@within</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>@target</code></span><span class="inline-wrap">, </span><span class="inline-wrap"><code>@annotation</code></span><span class="inline-wrap">, and </span><span class="inline-wrap"><code>@args</code></span><span class="inline-wrap">) can all be bound in a similar fashion. The next two examples show how to match the execution of methods annotated with an </span><span class="inline-wrap"><code>@Auditable</code></span><span class="inline-wrap"> annotation and extract the audit code:</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">The first of the two examples shows the definition of the </span><span class="inline-wrap"><code>@Auditable</code></span><span class="inline-wrap"> annotation:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Auditable</span> <span class="token punctuation">{</span>
    <span class="token class-name">AuditCode</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">The second of the two examples shows the advice that matches the execution of </span><span class="inline-wrap"><code>@Auditable</code></span><span class="inline-wrap">methods:</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"com.xyz.lib.Pointcuts.anyPublicMethod() &amp;&amp; @annotation(auditable)"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">audit</span><span class="token punctuation">(</span><span class="token class-name">Auditable</span> auditable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AuditCode</span> code <span class="token operator">=</span> auditable<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">Advice<span class="jill"></span>泛型参数</span></h4><h4 class="wolai-block"><span class="inline-wrap">设置参数名</span></h4><h4 class="wolai-block"><span class="inline-wrap">参数处理</span></h4><h4 class="wolai-block"><span class="inline-wrap">Advice<span class="jill"></span>执行顺序</span></h4></article><footer></footer></body></html>