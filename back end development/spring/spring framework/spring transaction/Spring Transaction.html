<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../css/wolai.css"/><title>Spring Transaction - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="Spring Transaction" class="main-title"></div></div></header><article><h1 class="wolai-block"><span class="inline-wrap">JDBC</span></h1><div class="wolai-block wolai-text"><div><span class="pink inline-wrap">JDBC<span class="jill"></span>提供了统一的<span class="jill"></span>API<span class="jill"></span>来对数据库进行操作。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">JDBC<span class="jill"></span>的核心是驱动类(</span><span class="inline-wrap"><code>Driver</code></span><span class="inline-wrap">)，驱动类由具体的数据库供应商所提供。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">从<span class="jill"></span>JDBC 4.0<span class="jill"></span>开始，当驱动类被载入后，它会把自己注册到</span><span class="inline-wrap"><code>java.sql.DriverManager </code></span><span class="inline-wrap">，</span><span class="inline-wrap"><code>DriverManager</code></span><span class="inline-wrap">负责管理驱动以及提供静态方法建立与数据库的连接。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>DriverManager</code></span><span class="inline-wrap">的</span><span class="inline-wrap"><code>getConnection</code></span><span class="inline-wrap">方法会返回</span><span class="inline-wrap"><code>java.sql.Connection</code></span><span class="inline-wrap">接口的实现类，该实现类也是由数据库供应商实现，通过该实现类对数据库运行<span class="jill"></span>SQL<span class="jill"></span>语句。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">从<span class="jill"></span>JDBC 4.0<span class="jill"></span>开始，JDBC<span class="jill"></span>新增了一个</span><span class="inline-wrap"><code>DataSource</code></span><span class="inline-wrap">接口，也是用来获取</span><span class="inline-wrap"><code>java.sql.Connection</code></span><span class="inline-wrap">，官方更推荐使用这个。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://www.wolai.com/makBWqCvqTn9GeX41FFx2P#makBWqCvqTn9GeX41FFx2P" class="wolai-bi-link"><span class="embed-page">JDBC</span></a></span></div></div><h1 class="wolai-block"><span class="inline-wrap">SpringJDBC</span></h1><h2 class="wolai-block"><span class="inline-wrap">数据库连接和数据源</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">通过注册一个实现了</span><span class="inline-wrap"><code>javax.sql.DataSource</code></span><span class="inline-wrap">接口的<span class="jill"></span>Bean，Spring<span class="jill"></span>可以为我们管理数据库连接（</span><span class="inline-wrap"><code>database connection</code></span><span class="inline-wrap">）。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>org.springframework.jdbc.datasource.DriverManagerDataSource</code></span><span class="inline-wrap">是最简单的实现类，通过类名你就可以猜出，它是利用</span><span class="inline-wrap"><code>DriverManager</code></span><span class="inline-wrap">来获取</span><span class="inline-wrap"><code>Connection</code></span><span class="inline-wrap">。事实上，</span><span class="inline-wrap"><code>DriverManagerDataSource</code></span><span class="inline-wrap">并不支持数据库连接池，所以它只能用来做测试使用。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span><span class="token string">"classpath:db/jdbc2.properties"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DbConfig</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${driverClassName}"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> driverClassName<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${url}"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${username}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${password}"</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DriverManagerDataSource</span> dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DriverManagerDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> </pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">在实际生产中，你可以使用<span class="jill"></span>Apache Commons </span><span class="inline-wrap"><code>BasicDataSource</code></span><span class="inline-wrap"> 或者其它。</span></div></div><h2 class="wolai-block"><span class="inline-wrap">内置数据库支持</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">从<span class="jill"></span>Spring3.0<span class="jill"></span>开始，Spring<span class="jill"></span>提供内置数据库支持，下面是配置内置数据库的一些代码</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmbeddedJdbcConfig</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">EmbeddedJdbcConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Bean</span>
  <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">EmbeddedDatabaseBuilder</span> dbBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmbeddedDatabaseBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> dbBuilder<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">EmbeddedDatabaseType</span><span class="token punctuation">.</span>H2<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addScripts</span><span class="token punctuation">(</span><span class="token string">"classpath:db/h2/schema.sql"</span><span class="token punctuation">,</span> 
                            <span class="token string">"classpath:db/h2/test-data.sql"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Embedded DataSource bean cannot be created!"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span></pre></div></code-block><h2 class="wolai-block"><span class="inline-wrap">DAO<span class="jill"></span>模式</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">Data Access Object 模式由以下几个组件组成：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">DAO<span class="jill"></span>接口</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">DAO<span class="jill"></span>接口实现类</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">模型对象（Model Object）也叫作（data object、entities）</span></li></ul><h1 class="wolai-block"><span class="inline-wrap">Spring<span class="jill"></span>事务管理</span></h1><div class="wolai-block wolai-text"><div><span class="inline-wrap"><a href="https://www.cnblogs.com/takemybreathaway/articles/6396885.html?from=timeline"><span>Spring<span class="jill"></span>事务管理</span></a></span></div></div><h2 class="wolai-block"><span class="inline-wrap">Spring<span class="jill"></span>事务管理的三个接口</span></h2><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>PlatformTransactionManager</code></span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>TransactionDefinition</code></span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>TransactionStatus</code></span></li></ul><h3 class="wolai-block"><span class="inline-wrap">PlatformTransactionManager</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">Spring<span class="jill"></span>并不直接管理事务，而是提供了多种事务管理器，他们将事务管理的职责委托给<span class="jill"></span>Hibernate<span class="jill"></span>或者<span class="jill"></span>JTA<span class="jill"></span>等持久化机制所提供的相关平台框架的事务来实现。 Spring<span class="jill"></span>事务管理器的接口是</span><span class="inline-wrap"><code>PlatformTransactionManager</code></span><span class="inline-wrap">，通过这个接口，Spring<span class="jill"></span>为各个平台如<span class="jill"></span>JDBC、Hibernate<span class="jill"></span>等都提供了对应的事务管理器，但是具体的实现就是各个平台自己的事情了。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PlatformTransactionManager</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransactionStatus</span> <span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">TransactionDefinition</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>TransactionDefinition</code></span><span class="inline-wrap">类定义了一些基本的事务属性。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">事务属性：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">传播行为</span><span class="inline-wrap">
</span><span class="inline-wrap">当事务方法被另一个事务方法调用时，必须指定事务应该如何传播。例如：方法可能继续在现有事务中运行，也可能开启一个新事务，并在自己的事务中运行。</span><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="纯文本" class="marker"></div><pre><span class="token constant">PROPAGATION_REQUIRED</span>        支持当前事务，如果不存在 就新建一个
<span class="token constant">PROPAGATION_SUPPORTS</span>        支持当前事务，如果事务不存在，就不使用事务
<span class="token constant">PROPAGATION_MANDATORY</span>       支持当前事务，如果不存在，则抛出异常
<span class="token constant">PROPAGATION_REQUIRES_NEW</span>    如果有事务存在，挂起当前事务，创建一个新的事务
<span class="token constant">PROPAGATION_NOT_SUPPORTED</span>   以非事务的方式运行，如果有事务存在，挂起当前事务
<span class="token constant">PROPAGATION_NEVER</span>           以非事务的方式运行，如果有事务存在，抛出异常
<span class="token constant">PROPAGATION_NESTED</span>          如果当前事务存在，则嵌套事务执行</pre></div></code-block></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">隔离级别</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">read uncommited：是最低的事务隔离级别，它允许另外一个事务可以看到这个事务未提交的数据。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">read commited：保证一个事物提交后才能被另外一个事务读取。另外一个事务不能读取该事物未提交的数据。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">repeatable read：这种事务隔离级别可以防止脏读，不可重复读。但是可能会出现幻象读。它除了保证一个事务不能被另外一个事务读取未提交的数据之外还避免了以下情况产生（不可重复读）。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">serializable：这是花费最高代价但最可靠的事务隔离级别。事务被处理为顺序执行。除了防止脏读，不可重复读之外，还避免了幻读</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">回滚规则</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">事务超时</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">所谓事务超时，就是指一个事务所允许执行的最长时间，如果超过该时间限制但事务还没有完成，则自动回滚事务。在 TransactionDefinition 中以 int 的值来表示超时时间，其单位是秒。</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">是否只读</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">只读事务用于客户代码只读但不修改数据的情形，只读事务用于特定情景下的优化，比如使用<span class="jill"></span>Hibernate<span class="jill"></span>的时候。</span></li></ul></li></ul><h3 class="wolai-block"><span class="inline-wrap">TransactionStatus</span></h3><h2 class="wolai-block"><span class="inline-wrap">编程式和声明式事务管理</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap">Spring<span class="jill"></span>将事务管理分为了两类：</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">编程式事务管理（很少用）</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">声明式事务管理</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">基于</span><span class="inline-wrap"><code>TransactionProxyFactoryBean</code></span><span class="inline-wrap">的方式（很少用）</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="red inline-wrap">基于注解的方式（常用）</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">基于</span><span class="inline-wrap"><code>AspectJ</code></span><span class="inline-wrap">的方式</span></li></ul></li></ul><h3 class="wolai-block"><span class="inline-wrap">基于注解的事务管理</span></h3><ol class="wolai-block"><li><div class="marker"></div><span class="inline-wrap">用</span><span class="inline-wrap"><code>@EnableTransactionManagement</code></span><span class="inline-wrap">修饰</span><span class="inline-wrap"><code>@Configuration</code></span><span class="inline-wrap">类</span></li><li><div class="marker"></div><span class="inline-wrap">用</span><span class="inline-wrap"><code>@Transactional</code></span><span class="inline-wrap">修饰</span><span class="inline-wrap"><code>DAO</code></span><span class="inline-wrap">类</span></li></ol><h4 class="wolai-block"><span class="inline-wrap">@Transactional</span></h4><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>@Transactional</code></span><span class="inline-wrap"> 可以作用在接口、类、类方法。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">当把</span><span class="inline-wrap"><code>@Transactional</code></span><span class="inline-wrap"> 注解放在类上时，表示所有该类的</span><span class="inline-wrap"><code>public</code></span><span class="inline-wrap">方法都配置相同的事务属性信息。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">当类配置了</span><span class="inline-wrap"><code>@Transactional</code></span><span class="inline-wrap">，方法也配置了</span><span class="inline-wrap"><code>@Transactional</code></span><span class="inline-wrap">，方法的事务会覆盖类的事务配置信息。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">不推荐在接口上使用</span><span class="inline-wrap"><code>@Transactional</code></span><span class="inline-wrap">注解，如果</span><span class="inline-wrap"><code>AOP</code></span><span class="inline-wrap"> 使用</span><span class="inline-wrap"><code>CGLib</code></span><span class="inline-wrap">生成代理，会导致注解失效。</span></div></div><hr class="wolai-block"/><details class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>@Transactional</code></span><span class="inline-wrap">注解应用在非</span><span class="inline-wrap"><code>public</code></span><span class="inline-wrap"> 修饰的方法上会失效</span></summary><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>TransactionInterceptor</code></span><span class="inline-wrap">在目标方法执行前后进行拦截，</span><span class="inline-wrap"><code>DynamicAdvisedInterceptor</code></span><span class="inline-wrap">的 </span><span class="inline-wrap"><code>intercept</code></span><span class="inline-wrap"> 方法或 </span><span class="inline-wrap"><code>JdkDynamicAopProxy</code></span><span class="inline-wrap"> 的 </span><span class="inline-wrap"><code>invoke</code></span><span class="inline-wrap"> 方法，会间接调用 </span><span class="inline-wrap"><code>AbstractFallbackTransactionAttributeSource</code></span><span class="inline-wrap">的 </span><span class="inline-wrap"><code>computeTransactionAttribute</code></span><span class="inline-wrap"> 方法，获取<span class="jill"></span>Transactional 注解的事务配置信息。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang=".properties" class="marker"></div><pre><span class="token keyword">protected</span> <span class="token maybe-class-name">TransactionAttribute</span> <span class="token function">computeTransactionAttribute</span><span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">Method</span> method<span class="token punctuation">,</span>
    <span class="token maybe-class-name">Class</span><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Don't allow no-public methods as required.</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">allowPublicMethodsOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token maybe-class-name">Modifier</span><span class="token punctuation">.</span><span class="token method function property-access">isPublic</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token method function property-access">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>
        <span class="token comment">// ....</span>
<span class="token punctuation">}</span>
</pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap">此方法会检查目标方法的修饰符是否为 </span><span class="inline-wrap"><code>public</code></span><span class="inline-wrap">，不是 </span><span class="inline-wrap"><code>public</code></span><span class="inline-wrap">则不会获取</span><span class="inline-wrap"><code>@Transactional</code></span><span class="inline-wrap"> 的属性配置信息。</span></div></div><blockquote class="wolai-block"><span class="inline-wrap"><b>注意：</b></span><span class="inline-wrap"><b><code>protected</code></b></span><span class="inline-wrap"><b>、</b></span><span class="inline-wrap"><b><code>private</code></b></span><span class="inline-wrap"><b> 修饰的方法上使用 </b></span><span class="inline-wrap"><b><code>@Transactional</code></b></span><span class="inline-wrap"><b> 注解，虽然事务无效，但不会有任何报错，这是我们很容犯错的一点。</b></span></blockquote></details><details class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>@Transactional</code></span><span class="inline-wrap"> 注解属性 </span><span class="inline-wrap"><code>propagation</code></span><span class="inline-wrap"> 设置错误</span></summary><div class="wolai-block wolai-text"><div><span class="inline-wrap">这种失效是由于配置错误，若是错误的配置以下三种 propagation，事务将不会发生回滚</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>TransactionDefinition.PROPAGATION_SUPPORTS</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"> </span><span class="inline-wrap"><code>TransactionDefinition.PROPAGATION_NOT_SUPPORTED</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">以非事务方式运行，如果当前存在事务，则把当前事务挂起。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>TransactionDefinition.PROPAGATION_NEVER</code></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">以非事务方式运行，如果当前存在事务，则抛出异常</span></div></div></details><details class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap"><code>@Transactional</code></span><span class="inline-wrap"> 注解属性 </span><span class="inline-wrap"><code>rollbackFor</code></span><span class="inline-wrap"> 设置错误</span></summary><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>rollbackFor</code></span><span class="inline-wrap"> 可以指定能够触发事务回滚的异常类型。Spring<span class="jill"></span>默认抛出了未检查</span><span class="inline-wrap"><code>unchecked</code></span><span class="inline-wrap">异常（继承自 </span><span class="inline-wrap"><code>RuntimeException</code></span><span class="inline-wrap"> 的异常）或者 </span><span class="inline-wrap"><code>Error</code></span><span class="inline-wrap">才回滚事务；其他异常不会触发回滚事务。如果在事务中抛出其他类型的异常，但却期望 Spring 能够回滚事务，就需要指定 </span><span class="inline-wrap"><b><code>rollbackFor</code></b></span><span class="inline-wrap">属性。</span></div></div><div class="wolai-block wolai-center"><figure style="width: 100%"><img src="media/image.png" style="width: 718px"/></figure></div></details><details class="wolai-block"><summary><div class="marker"></div><span class="inline-wrap">同一个类中方法调用，导致</span><span class="inline-wrap"><code>@Transactional</code></span><span class="inline-wrap">失效</span></summary><div class="wolai-block wolai-text"><div><span class="inline-wrap">为什么？</span></div></div></details><details class="wolai-block"><summary><div class="marker placeholder"></div><span class="inline-wrap">异常被<span class="jill"></span>catch<span class="jill"></span>住，没有往外传递</span></summary></details><details class="wolai-block"><summary><div class="marker placeholder"></div><span class="inline-wrap">数据库不支持事务</span></summary></details><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div><div class="wolai-bookmark wolai-block"><a href="https://juejin.cn/post/6844904096747503629">一口气说出 6种，@Transactional注解的失效场景 - 掘金</a><div class="info-box"><div class="text-pane"><div data-title="一口气说出 6种，@Transactional注解的失效场景 - 掘金"></div><div data-desc="昨天公众号粉丝咨询了一个问题，说自己之前面试被问@Transactional注解哪些场景下会失效，一时语塞致使面试失败。所以今天简单的和大家分享一下@Transactional相关的知识。 @Transactional 注解相信大家并不陌生，平时开发中很常用的一个注解，它能保证…"></div><div class="icon-host"><div class="icon icon-image" style="background-image: url(&quot;https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/favicons/apple-touch-icon.png&quot;)"></div><div data-hostname="juejin.cn"></div></div></div><div class="preview-pane"></div></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"></span><br/></div></div></article><footer></footer></body></html>