<!DOCTYPE html>
<html lang="zh-Hans-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=Edge"/><link rel="stylesheet" type="text/css" href="../../../../../css/modern-norm.min.css"/><link rel="stylesheet" type="text/css" href="../../../../../css/prism.min.css"/><link rel="stylesheet" type="text/css" href="../../../../../css/katex.min.css"/><link rel="stylesheet" type="text/css" href="../../../../../css/wolai.css"/><title>DefaultListableBeanFactory - wolai 笔记</title><link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns=&apos;http://www.w3.org/2000/svg&apos; viewBox=&apos;0 0 800 800&apos;%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:%23fff;%7D%3C/style%3E%3C/defs%3E%3Cg%3E%3Cpath class=&apos;cls-1&apos; d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Z&apos;/%3E%3Cpath d=&apos;M610.08,0c66,0,90,6.88,114.13,19.79a134.62,134.62,0,0,1,56,56l2.28,4.4C793.93,103,800,127.88,800,189.92V610.08l-.08,11.56c-.78,57.38-7.58,79.89-19.71,102.57a134.62,134.62,0,0,1-56,56l-4.4,2.28C697,793.93,672.12,800,610.08,800H189.92l-11.56-.08c-57.38-.78-79.89-7.58-102.57-19.71a134.62,134.62,0,0,1-56-56l-2.28-4.4C6.44,697.75.4,673.72,0,616L0,189.92c0-66,6.88-90,19.79-114.13a134.62,134.62,0,0,1,56-56l4.4-2.28C102.25,6.44,126.28.4,184,0Zm4.72,88.9H185.2L172.42,89c-32.78.62-43.68,3.24-54.71,9.14a45.84,45.84,0,0,0-19.54,19.54c-6.61,12.36-9.11,24.55-9.27,67.49V614.8L89,627.58c.62,32.78,3.24,43.68,9.14,54.71a45.84,45.84,0,0,0,19.54,19.54c12.36,6.61,24.55,9.11,67.49,9.27H610.08c46.79,0,59.41-2.44,72.21-9.28a45.84,45.84,0,0,0,19.54-19.54c6.61-12.36,9.11-24.55,9.27-67.49V189.92c0-46.79-2.44-59.41-9.28-72.21a45.84,45.84,0,0,0-19.54-19.54C669.93,91.56,657.74,89.06,614.8,88.9ZM233.33,493.33A73.34,73.34,0,1,1,160,566.67,73.35,73.35,0,0,1,233.33,493.33Z&apos;/%3E%3C/g%3E%3C/svg%3E"></link></head><body><header><div class="image"></div><div class="title"><div class="banner"><div class="icon"></div></div><div data-title="DefaultListableBeanFactory" class="main-title"></div></div></header><article><h1 class="wolai-block"><span class="inline-wrap">简介</span></h1><div class="wolai-block wolai-text"><div><span class="inline-wrap">Spring<span class="jill"></span>的<span class="jill"></span>IoC<span class="jill"></span>容器有两个重要的接口，分别是</span><span class="inline-wrap"><code>BeanFactory</code></span><span class="inline-wrap">和</span><span class="inline-wrap"><code>ApplicationContext</code></span><span class="inline-wrap">。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>BeanFactory</code></span><span class="inline-wrap">是最基础的容器，它规定了容器应该提供的基本服务。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>ApplicationContext</code></span><span class="inline-wrap">是前者的扩展，它添加很多开发企业级应用需要用到的功能。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">为了更好的区分，我把</span><span class="inline-wrap"><code>BeanFactory</code></span><span class="inline-wrap">称为低级容器，</span><span class="inline-wrap"><code>ApplicationContext</code></span><span class="inline-wrap">称为高级容器。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">无论是</span><span class="inline-wrap"><code>BeanFactory</code></span><span class="inline-wrap">还是</span><span class="inline-wrap"><code>ApplicationContext</code></span><span class="inline-wrap">它们的工作流程都是大致相同的。</span></div></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">获取配置文件</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">读取配置文件中定义的</span><span class="inline-wrap"><code>Bean</code></span><span class="inline-wrap">，然后转换成</span><span class="inline-wrap"><code>BeanDefinition</code></span><span class="inline-wrap">对象</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">在容器上注册</span><span class="inline-wrap"><code>BeanDefinition</code></span><span class="inline-wrap">对象（使用</span><span class="inline-wrap"><code>HashMap</code></span><span class="inline-wrap">）</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">根据</span><span class="inline-wrap"><code>BeanDefinition</code></span><span class="inline-wrap">完成</span><span class="inline-wrap"><code>Bean</code></span><span class="inline-wrap">的创建以及依赖注入</span></li></ul><h2 class="wolai-block"><span class="inline-wrap">DefaultListableBeanFactory</span></h2><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>DefaultListableBeanFactory</code></span><span class="inline-wrap">是简单容器的一个实现。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>XmlBeanFactory</code></span><span class="inline-wrap">在其基础上进行扩展，添加了读取<span class="jill"></span>XML<span class="jill"></span>配置生成</span><span class="inline-wrap"><code>BeanDefinition</code></span><span class="inline-wrap">的功能。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XmlBeanFactory</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultListableBeanFactory</span> <span class="token punctuation">{</span>
  <span class="token comment">// .......</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>GenericApplicationContext</code></span><span class="inline-wrap"> 通过组合它的方式实现容器的功能</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericApplicationContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractApplicationContext</span> 
  <span class="token keyword">implements</span> <span class="token class-name">BeanDefinitionRegistry</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultListableBeanFactory</span> beanFactory<span class="token punctuation">;</span>
  <span class="token comment">// .......</span>
<span class="token punctuation">}</span></pre></div></code-block><div class="wolai-block wolai-text"><div><span class="inline-wrap"><code>DefaultListableBeanFactory</code></span><span class="inline-wrap">关键的接口与类的介绍：</span></div></div><div class="wolai-block wolai-center"><figure><img src="media/defaultlistablebeanfactory%E7%BB%A7%E6%89%BF%E5%9B%BE.png" style="width: 760px"/></figure></div><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>AliasRegistry</code></span><span class="inline-wrap">:</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">别名注册：定义了对</span><span class="inline-wrap"><code>alias</code></span><span class="inline-wrap">的<span class="jill"></span>CRUD<span class="jill"></span>等操作。</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>SimpleAliasRegistry</code></span><span class="inline-wrap">:</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>AliasRegistry</code></span><span class="inline-wrap">的实现：使用</span><span class="inline-wrap"><code>ConcurrentHashMap</code></span><span class="inline-wrap">存储</span><span class="inline-wrap"><code>alias</code></span><span class="inline-wrap">。</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>BeanDefinitionRegistry</code></span><span class="inline-wrap">：</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>BeanDefinition</code></span><span class="inline-wrap">注册：定义了</span><span class="inline-wrap"><code>BeanDefinition</code></span><span class="inline-wrap">的<span class="jill"></span>CRUD<span class="jill"></span>等操作。</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>SingletonBeanRegistry</code></span><span class="inline-wrap">：</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">单例</span><span class="inline-wrap"><code>Bean</code></span><span class="inline-wrap">注册：定义了单例</span><span class="inline-wrap"><code>Bean</code></span><span class="inline-wrap">的注册和获取等操作。</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>DefaultSingletonBeanRegistry</code></span><span class="inline-wrap">：</span><span class="inline-wrap"><code>SingletonBeanRegistry</code></span><span class="inline-wrap">的实现，</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>BeanFactory</code></span><span class="inline-wrap">：IoC<span class="jill"></span>容器的基础接口，定义了基本的获取<span class="jill"></span>Bean<span class="jill"></span>以及<span class="jill"></span>Bean<span class="jill"></span>属性的方法。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>HierarchicalBeanFactory</code></span><span class="inline-wrap"> ：</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">具有层级结构的</span><span class="inline-wrap"><code>BeanFactory</code></span><span class="inline-wrap">：让</span><span class="inline-wrap"><code>BeanFactory</code></span><span class="inline-wrap">拥有获取</span><span class="inline-wrap"><code>ParentBeanFactory</code></span><span class="inline-wrap">的能力。</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>FactoryBeanRegistrySupport</code></span><span class="inline-wrap">：在</span><span class="inline-wrap"><code>DefaultSingletonBeanRegistry</code></span><span class="inline-wrap">的基础上添加了对</span><span class="inline-wrap"><code>FactoryBean</code></span><span class="inline-wrap">的特殊处理功能。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>ConfigurableBeanFactory</code></span><span class="inline-wrap">：</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">可配置的</span><span class="inline-wrap"><code>BeanFactory</code></span><span class="inline-wrap">：定义了配置</span><span class="inline-wrap"><code>BeanFactory</code></span><span class="inline-wrap">的各种方法。</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>ListableBeanFactory</code></span><span class="inline-wrap">：</span><ul class="wolai-block"><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap">可监听的</span><span class="inline-wrap"><code>BeanFactory</code></span><span class="inline-wrap">：新增遍历所有</span><span class="inline-wrap"><code>Bean</code></span><span class="inline-wrap">实例的功能，不用一个一个的获取</span><span class="inline-wrap"><code>Bean</code></span><span class="inline-wrap">，如果具有父工厂，获取的</span><span class="inline-wrap"><code>Bean</code></span><span class="inline-wrap">不包括父工厂中的</span><span class="inline-wrap"><code>Bean</code></span><span class="inline-wrap">。</span></li></ul></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>AbstractBeanFactory</code></span><span class="inline-wrap">：综合</span><span class="inline-wrap"><code>FactoryBeanRegistrySupport</code></span><span class="inline-wrap">和</span><span class="inline-wrap"><code>ConfigurableBeanFactory</code></span><span class="inline-wrap">的功能。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>AutowireCapableBeanFactory</code></span><span class="inline-wrap">：提供创建</span><span class="inline-wrap"><code>Bean</code></span><span class="inline-wrap">   自动注入   初始化以及应用</span><span class="inline-wrap"><code>Bean</code></span><span class="inline-wrap">的后处理功能。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>AbstractAutowireCapableBeanFactory</code></span><span class="inline-wrap">：继承</span><span class="inline-wrap"><code>AbstractBeanFactory</code></span><span class="inline-wrap">，实现</span><span class="inline-wrap"><code>AutowireCapableBeanFactory</code></span><span class="inline-wrap">。</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>ConfigurableListableBeanFactory</code></span><span class="inline-wrap">：</span></li><li><div class="marker"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg></div><span class="inline-wrap"><code>DefaultListableBeanFactory</code></span><span class="inline-wrap">：</span></li></ul><div class="wolai-block wolai-text"><div><span class="inline-wrap"><b>要求：看到名称可以想起它的作用</b></span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">前面我们已经看了<span class="jill"></span>Bean<span class="jill"></span>定义创建和注册的流程了，现在来看<span class="jill"></span>Bean<span class="jill"></span>创建的流程</span></div></div><h1 class="wolai-block"><span class="inline-wrap">Bean<span class="jill"></span>的创建</span></h1><div class="wolai-block wolai-text"><div><span class="inline-wrap">Bean<span class="jill"></span>的创建主要是使用</span><span class="inline-wrap"><code>AbstractBeanFactory</code></span><span class="inline-wrap">的</span><span class="inline-wrap"><code>doGetBean</code></span><span class="inline-wrap">方法。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> requiredType<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析Bean名字</span>
    <span class="token comment">// 尝试从单例Bean缓存获取Bean</span>
<span class="token punctuation">}</span></pre></div></code-block><h2 class="wolai-block"><span class="inline-wrap">解析<span class="jill"></span>Bean<span class="jill"></span>名字</span></h2><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">// 解析Bean名，获取Bean的唯一名</span>
<span class="token comment">// 为什么要解析Bean名？ 因为你传递过来的可能是Bean的别名，也有可能是FactoryBean的名。</span>
<span class="token keyword">final</span> <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block><h2 class="wolai-block"><span class="inline-wrap">尝试从单例<span class="jill"></span>Bean<span class="jill"></span>缓存获取<span class="jill"></span>Bean</span></h2><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">// 尝试从缓存中获取该Bean，一个创建完毕的单例Bean，会被缓存起来</span>
<span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">第二个重载方法</span></h3><div class="wolai-block wolai-text"><div><span class="inline-wrap">第二个重载方法，是负责获取已存在的单例<span class="jill"></span>Bean。</span></div></div><div class="wolai-block wolai-text"><div><span class="inline-wrap">第三个重载方法，是创建单例<span class="jill"></span>Bean，我们会在后面本地创建<span class="jill"></span>Bean<span class="jill"></span>的部分看到它。</span></div></div><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token doc-comment comment">/**
    上面我们讲到，该方法负责获取已存在的单例Bean，它的工作流程如下：
    1.先从singletonObjects寻找，找不到，从earlySingletonObjects寻找，再找不到，
    2.那就从singletonFactories寻找对应ObjectFactory，
    3.如果找不到，那就只有返回null了
    4.找到ObjectFactory，则创建SingletonBean，然后放入earlySingletonObjects
    5.返回SingletonBean
*/</span>
  
  <span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> singletonFactory <span class="token operator">=</span> 
                    <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
singletonObjects存放创建并初始化完毕的Bean，很好理解
但是earlySingletonObjects和singletonFactories存在的意义是什么？
还有earlySingletonObjects存放ObjectFactory给它的Bean，
那么singletonFactories存储的ObjectFactory是哪里来的？为什么需要它？

其实这两个容器是为了处理循环依赖问题而存在的

Spring中的循环依赖有两种情况，分别是构造器循环依赖和属性循环依赖。
构造器循环依赖是无解的，只能抛出BeanCurrentlyInCreateionException。
对于属性循环依赖，也只有单例的Bean出现属性循环依赖的时候才可以解决。

假设现在有单例Bean A B C , A依赖B ，B依赖C ，C依赖A

获取单例Bean A

尝试从缓存获取A
  因为A还没创建，
  this.singletonObjects.get(beanName)
  isSingletonCurrentlyInCreation(beanName)
  皆为null，该方法返回null
       
之后代码会执行到第三个重载方法，这时候就是创建A了
     创建A，往singletonFactories放入A对应的ObjectFactory，
     isSingletonCurrentlyInCreation(beanName)为true，
     
     因为A依赖B，所以调用了doGetBean(B)
     获取B，一样的流程，最后也往singletonFactories放入B对应的ObjectFactory，
     获取C，一样的流程，最后也往singletonFactories放入C对应的ObjectFactory，
       
第二次获取A
     由于C依赖A，因此又调用了doGetBean(A)，此时再次进入第二个重载方法，
     由于此时的A的ObjectFactory已存在，因此可以获取到A
     C成功注入了A，C创建完毕，然后B也创建完毕，最后A也创建完毕
  
  这里看上去可能还是有点抽象，目前只需有个印象即可，知道以下两点即可
  1.第二个重载方法是获取单例Bean，第三个重载方法是创建单例Bean
  2.四个容器的作用
**/</span> </pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">从父工厂获取<span class="jill"></span>Bean</span></h3><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token class-name">BeanFactory</span> parentBeanFactory <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span> nameToLookup <span class="token operator">=</span> <span class="token function">originalBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doGetBean</span><span class="token punctuation">(</span>
      nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> args<span class="token punctuation">,</span> typeCheckOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Delegation to parent with explicit args.</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// No args -> delegate to standard getBean method.</span>
    <span class="token keyword">return</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div></code-block><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>typeCheckOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">markBeanAsCreated</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div></code-block><h3 class="wolai-block"><span class="inline-wrap">本地创建<span class="jill"></span>Bean</span></h3><h4 class="wolai-block"><span class="inline-wrap">构造<span class="jill"></span>RootBeanDefinition</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token doc-comment comment">/** 
  AbstractBeanDefinition 有三个子类，分别是RootBeanDefinition ChildBeanDefinition GenericBeanDefinition

  GenericBeanDefinition 是通用的BeanDefinition,可以满足任何要求的BeanDefinition，读取配置后生成的就是GenericBeanDefinition。
  
  Spring在创建Bean的时候用的是RootBeanDefinition。RootBeanDifinition主要由 GenericBeanDefinition 及其 ParentBeanDefinition合并而来。GenericBeanDefinition的 getParentName方法会返回parentBeanName，而RootBeanDefinition的getParentName始终返回的是 null。
  
  getMergedLocalBeanDefinition方法将非RootBeanDefinition转换为RootBeanDefinition以供后续操作。
*/</span>
<span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div></code-block><h4 class="wolai-block"><span class="inline-wrap">处理<span class="jill"></span>DependsOn</span></h4><code-block class="wolai-block"><div class="wolai-pre"><div data-lang="Java" class="marker"></div><pre><span class="token comment">// depends-on 与 ref 的区别</span>
<span class="token comment">// depends-on用于Bean的初始化以及单例Bean的销毁过程，初始化时，depends-on的Bean先被创建，</span>
<span class="token comment">// 销毁时，depends-on的Bean先被销毁</span>
<span class="token comment">// 创建Bean之前，确保它的依赖已经被初始化</span>
<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependsOn <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>dependsOn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dep <span class="token operator">:</span> dependsOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDependent</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 抛出异常 循环依赖</span>
    <span class="token punctuation">}</span>
    <span class="token function">registerDependentBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">getBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span><span class="token string">"省略...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre></div></code-block><div class="wolai-block wolai-text"><div></div></div></article><footer></footer></body></html>